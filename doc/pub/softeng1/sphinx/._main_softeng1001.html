

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Sample problem and code</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Scientific software engineering with a simple ODE model as example" href="index.html" />
    <link rel="next" title="Software engineering" href="._main_softeng1002.html" />
    <link rel="prev" title="Scientific software engineering with a simple ODE model as example" href="._main_softeng1000.html" />
 
  
   <style type="text/css">
     div.admonition {
       background-color: whiteSmoke;
       border: 1px solid #bababa;
     }
   </style>
  </head>

  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._main_softeng1002.html" title="Software engineering"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="._main_softeng1000.html" title="Scientific software engineering with a simple ODE model as example"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Scientific software engineering with a simple ODE model as example</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="admonition-goal admonition">
<p class="first admonition-title">Goal</p>
<p>This document illustrates <em>best practice</em> for developing scientific software
in an efficient and reliable way. Not only will the outlined techniques
save a lost of human time, but they will also help assure reproducible science
and higher quality of computational investigations. Key questions to
be answered are</p>
<blockquote class="last">
<div><ul class="simple">
<li>How should I organize a program?</li>
<li>How can I efficiently and safely provide input data and run my code?</li>
<li>How can I verify that the implementation is correct?</li>
<li>How should I reliably work with files and documents?</li>
<li>How should I conduct large numerical experiments?</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="sample-problem-and-code">
<h1>Sample problem and code<a class="headerlink" href="#sample-problem-and-code" title="Permalink to this headline">¶</a></h1>
<p>This first introduction to good programming habits in scientific
computing will make use of a very simple mathematical problem to keep
the mathematical details at the lowest possible level while
introducing a series of computer science concepts. The simplicity of
the mathematical problem obviously prevents us from treating several
techniques that are only meaningful for complex scientific software.</p>
<div class="section" id="mathematical-problem">
<h2>Mathematical problem<a class="headerlink" href="#mathematical-problem" title="Permalink to this headline">¶</a></h2>
<p>We consider the simplest possible ordinary differential equation
with constant coefficient <span class="math">\(a\)</span>:</p>
<div class="math" id="equation-softeng1:problem:ode">
<span id="eq-softeng1-problem-ode"></span><span class="eqno">(1)</span>\[     u'(t) = -au(t),\quad u(0)=I,\quad t\in (0,T]{\thinspace .}\]</div>
<p>This problem is numerically solved by the so-called <span class="math">\(\theta\)</span>-rule,
which is a convenient way to merge different formulas for the
well-known Forward Euler, Backward Euler, and Crank-Nicolson
(midpoint/central) schemes. We introduce a uniform time mesh
<span class="math">\(t_n=n\Delta t\)</span>, <span class="math">\(n=0,1,\ldots,N_t\)</span>, and seek <span class="math">\(u(t)\)</span> at the mesh
points. The numerical approximation to <span class="math">\(u(t_n)\)</span> is denoted
<span class="math">\(u^n\)</span>. Since we will use the symbol <span class="math">\(u\)</span> both for the exact analytical
solution of <a href="#equation-softeng1:problem:ode">(1)</a> and for the numerical
approximation, we sometimes introduce <span class="math">\({u_{\small\mbox{e}}}(t)\)</span> to help distinguish
the two types of solutions (i.e., subscript e for &#8220;exact&#8221;) <a class="footnote-reference" href="#e-subscript" id="id1">[1]</a>.</p>
<table class="docutils footnote" frame="void" id="e-subscript" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>In the literature, it is more common to put a subscript
(like <span class="math">\(u_\Delta\)</span> or <span class="math">\(u_h\)</span>)
on the numerical solution to distinguish it from the exact solution.
However, we will use the variable <tt class="docutils literal"><span class="pre">u</span></tt> in the code for the numerical
approximation to be computed, and therefore adjust the mathematical
notation to convenient conventions in the code such that we can have
as close correspondence as possible between the implementation and
the mathematics.</td></tr>
</tbody>
</table>
<p>The <span class="math">\(\theta\)</span>-rule leads to an explicit updating formula for <span class="math">\(u^{n+1}\)</span>,
given <span class="math">\(u^n\)</span>:</p>
<div class="math">
\[u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,\]</div>
</div>
<div class="section" id="implementation-1">
<h2>Implementation  (1)<a class="headerlink" href="#implementation-1" title="Permalink to this headline">¶</a></h2>
<p>The numerical method is implemented as a function <tt class="docutils literal"><span class="pre">solver</span></tt>.
Another function <tt class="docutils literal"><span class="pre">explore</span></tt> computes the error in the solution,
by comparing with the exact solution <span class="math">\({u_{\small\mbox{e}}}(t)=Ie^{-at}\)</span>,
and creates a plot for comparing the numerical and exact solution.</p>
<p>The program file
<a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_plot.py">decay_plot.py</a> contains the two
functions and a main program.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>            <span class="c"># avoid integer division</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>     <span class="c"># no of time intervals</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span>                 <span class="c"># adjust T to fit time step dt</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>           <span class="c"># array of u[n] values</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># time mesh</span>

    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>                  <span class="c"># assign initial condition</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="p">):</span>    <span class="c"># n=0,1,...,Nt-1</span>
        <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">exact_solution</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a case with the solver, compute error measure,</span>
<span class="sd">    and plot the numerical and exact solutions (if makeplot=True).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>    <span class="c"># Numerical solution</span>
    <span class="n">u_e</span> <span class="o">=</span> <span class="n">exact_solution</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">u_e</span> <span class="o">-</span> <span class="n">u</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">makeplot</span><span class="p">:</span>
        <span class="n">figure</span><span class="p">()</span>                         <span class="c"># create new plot</span>
        <span class="n">t_e</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>       <span class="c"># fine mesh for u_e</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">exact_solution</span><span class="p">(</span><span class="n">t_e</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span>   <span class="n">u</span><span class="p">,</span>   <span class="s">&#39;r--o&#39;</span><span class="p">)</span>           <span class="c"># red dashes w/circles</span>
        <span class="n">plot</span><span class="p">(</span><span class="n">t_e</span><span class="p">,</span> <span class="n">u_e</span><span class="p">,</span> <span class="s">&#39;b-&#39;</span><span class="p">)</span>             <span class="c"># blue line for exact sol.</span>
        <span class="n">legend</span><span class="p">([</span><span class="s">&#39;numerical&#39;</span><span class="p">,</span> <span class="s">&#39;exact&#39;</span><span class="p">])</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">title</span><span class="p">(</span><span class="s">&#39;theta=</span><span class="si">%g</span><span class="s">, dt=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">theta2name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;FE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;BE&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s">&#39;CN&#39;</span><span class="p">}</span>
        <span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%g</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta2name</span><span class="p">[</span><span class="n">theta</span><span class="p">],</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%g</span><span class="s">.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta2name</span><span class="p">[</span><span class="n">theta</span><span class="p">],</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">E</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt_values</span><span class="p">,</span> <span class="n">theta_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">theta_values</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%6.2f</span><span class="s">: </span><span class="si">%12.3E</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>

<span class="n">main</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dt_values</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="user-interfaces">
<h1>User interfaces<a class="headerlink" href="#user-interfaces" title="Permalink to this headline">¶</a></h1>
<p>It is good programming practice to let programs read input from the
user rather than require the user to edit the source code when trying
out new values of input parameters. One reason is that any edit of the
code has a danger of introducing bugs. Another reason is that it is
easier and less manual work to supply data to a program instead of
editing the program code. A third reason is that a program that reads
input can easily be run by another program, and in this way we can
automate a large number of runs in scientific investigations.</p>
<div class="admonition-tip admonition">
<p class="first admonition-title">Tip</p>
<p class="last">We shall make it a habit to equip any implementation of a
numerical solver with an appropriate user interface before testing out
the code.</p>
</div>
<p>Reading input data can be done in many ways. We have to decide on
desired <em>user interface</em>, i.e., how we want to operate the program
when providing input, and then use appropriate tools to implement
the user interface. There are four basic types of user interface
of relevance to our programs, listed here with increasing complexity
of the implementation:</p>
<ol class="arabic simple">
<li>Questions and answers in the terminal window</li>
<li>Command-line arguments</li>
<li>Reading data from file</li>
<li>Graphical user interfaces</li>
</ol>
<p>Although conceptually simple, alternative 1 involves more typing than
the other alternatives and is therefore abandoned. Below, we shall
address alternative 2 and 4, which are most appropriate for the
present problem.</p>
<p>[[[
.. _decay:commandline:</p>
<div class="section" id="creating-command-line-interfaces">
<h2>Creating command-line interfaces<a class="headerlink" href="#creating-command-line-interfaces" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-0"></span><p id="index-1">Reading input from the command line is a simple and flexible way of interacting
with the user. Python stores all the command-line arguments in
the list <tt class="docutils literal"><span class="pre">sys.argv</span></tt>, and there are, in principle, two ways of programming with
command-line arguments in Python:</p>
<blockquote>
<div><ul class="simple">
<li>Decide upon a sequence of parameters on the command line and read
their values directly from the <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt> list (<tt class="docutils literal"><span class="pre">sys.argv[0]</span></tt> is
the just program name).</li>
<li>Use option-value pairs (<tt class="docutils literal"><span class="pre">--option</span> <span class="pre">value</span></tt>) on
the command line to override default values of input parameters,
and utilize the <tt class="docutils literal"><span class="pre">argparse.ArgumentParser</span></tt> tool to interact with
the command line.</li>
</ul>
</div></blockquote>
<p>Both strategies will be illustrated next.</p>
<div class="section" id="reading-a-sequence-of-command-line-arguments">
<h3>Reading a sequence of command-line arguments<a class="headerlink" href="#reading-a-sequence-of-command-line-arguments" title="Permalink to this headline">¶</a></h3>
<p id="index-2">The <a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_plot.py">decay_plot.py</a>
program needs the following input data: <span class="math">\(I\)</span>, <span class="math">\(a\)</span>, <span class="math">\(T\)</span>, an option to
turn the plot on or off (<tt class="docutils literal"><span class="pre">makeplot</span></tt>), and a list of <span class="math">\(\Delta t\)</span> values.</p>
<p>The simplest way of reading this input from the command line is to say
that the first four command-line arguments correspond to the first
four points in the list above, in that order, and that the rest of the
command-line arguments are the <span class="math">\(\Delta t\)</span> values.  The input given for
<tt class="docutils literal"><span class="pre">makeplot</span></tt> can be a string among <tt class="docutils literal"><span class="pre">'on'</span></tt>, <tt class="docutils literal"><span class="pre">'off'</span></tt>, <tt class="docutils literal"><span class="pre">'True'</span></tt>, and
<tt class="docutils literal"><span class="pre">'False'</span></tt>. The code for reading this input is most conveniently put in
a function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">read_command_line</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Usage: </span><span class="si">%s</span><span class="s"> I a T on/off dt1 dt2 dt3 ...&#39;</span> <span class="o">%</span> \
              <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># abort</span>

    <span class="n">I</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">makeplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;True&#39;</span><span class="p">)</span>
    <span class="n">dt_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">:]]</span>

    <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">,</span> <span class="n">dt_values</span>
</pre></div>
</div>
<span class="target" id="index-3"></span><p id="index-4">One should note the following about the constructions in the program above:</p>
<blockquote>
<div><ul class="simple">
<li>Everything on the command line ends up in a <em>string</em> in
the list <tt class="docutils literal"><span class="pre">sys.argv</span></tt>. Explicit conversion to, e.g., a <tt class="docutils literal"><span class="pre">float</span></tt> object is
required if the string as a number we want to compute with.</li>
<li>The value of <tt class="docutils literal"><span class="pre">makeplot</span></tt> is determined from a boolean expression,
which becomes <tt class="docutils literal"><span class="pre">True</span></tt> if the command-line argument is either <tt class="docutils literal"><span class="pre">'on'</span></tt> or
<tt class="docutils literal"><span class="pre">'True'</span></tt>, and <tt class="docutils literal"><span class="pre">False</span></tt> otherwise.</li>
<li>It is easy to build the list of <span class="math">\(\Delta t\)</span> values: we simply run through
the rest of the list, <tt class="docutils literal"><span class="pre">sys.argv[5:]</span></tt>, convert each command-line argument
to <tt class="docutils literal"><span class="pre">float</span></tt>, and collect these <tt class="docutils literal"><span class="pre">float</span></tt> objects in a list, using the
compact and convenient <em>list comprehension</em> syntax in Python.</li>
</ul>
</div></blockquote>
<p>The loops over <span class="math">\(\theta\)</span> and <span class="math">\(\Delta t\)</span> values can be coded in a <tt class="docutils literal"><span class="pre">main</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">,</span> <span class="n">dt_values</span> <span class="o">=</span> <span class="n">read_command_line</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%6.2f</span><span class="s">: </span><span class="si">%12.3E</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
</pre></div>
</div>
<p>The complete program can be found in <a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_cml.py">decay_cml.py</a>.</p>
</div>
<div class="section" id="working-with-an-argument-parser">
<h3>Working with an argument parser<a class="headerlink" href="#working-with-an-argument-parser" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-5"></span><span class="target" id="index-6"></span><span class="target" id="index-7"></span><span class="target" id="index-8"></span><p id="index-9">Python&#8217;s <tt class="docutils literal"><span class="pre">ArgumentParser</span></tt> tool in the <tt class="docutils literal"><span class="pre">argparse</span></tt> module makes it easy
to create a professional command-line interface to any program. The
documentation of <a class="reference external" href="http://docs.python.org/library/argparse.html">ArgumentParser</a> demonstrates its
versatile applications, so we shall here just list an example
containing basic features.  On the command line we want to specify
option-value pairs for <span class="math">\(I\)</span>, <span class="math">\(a\)</span>, and <span class="math">\(T\)</span>, e.g., <tt class="docutils literal"><span class="pre">--a</span> <span class="pre">3.5</span> <span class="pre">--I</span> <span class="pre">2</span> <span class="pre">--T</span>
<span class="pre">2</span></tt>. Including <tt class="docutils literal"><span class="pre">--makeplot</span></tt> turns the plot on and excluding this option
turns the plot off.  The <span class="math">\(\Delta t\)</span> values can be given as <tt class="docutils literal"><span class="pre">--dt</span> <span class="pre">1</span> <span class="pre">0.5</span>
<span class="pre">0.25</span> <span class="pre">0.1</span> <span class="pre">0.01</span></tt>.  Each parameter must have a sensible default value so
that we specify the option on the command line only when the default
value is not suitable.</p>
<p>We introduce a function for defining the mentioned command-line options:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">define_command_line_options</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--I&#39;</span><span class="p">,</span> <span class="s">&#39;--initial_condition&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;initial condition, u(0)&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;I&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--a&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;coefficient in ODE&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--T&#39;</span><span class="p">,</span> <span class="s">&#39;--stop_time&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;end time of simulation&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--makeplot&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;display plot or not&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--dt&#39;</span><span class="p">,</span> <span class="s">&#39;--time_step_values&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;time step values&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;dt&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dt_values&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>
</pre></div>
</div>
<p>Each command-line option is defined through the <tt class="docutils literal"><span class="pre">parser.add_argument</span></tt>
method. Alternative options, like the short <tt class="docutils literal"><span class="pre">--I</span></tt> and the more
explaining version <tt class="docutils literal"><span class="pre">--initial_condition</span></tt> can be defined. Other arguments
are <tt class="docutils literal"><span class="pre">type</span></tt> for the Python object type, a default value, and a help
string, which gets printed if the command-line argument <tt class="docutils literal"><span class="pre">-h</span></tt> or <tt class="docutils literal"><span class="pre">--help</span></tt> is
included. The <tt class="docutils literal"><span class="pre">metavar</span></tt> argument specifies the value associated with
the option when the help string is printed. For example, the option for
<span class="math">\(I\)</span> has this help output:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_argparse.py -h
  ...
  --I I, --initial_condition I
                        initial condition, u(0)
  ...
</pre></div>
</div>
<p>The structure of this output is</p>
<div class="highlight-text"><div class="highlight"><pre>--I metavar, --initial_condition metavar
                      help-string
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">--makeplot</span></tt> option is a pure flag without any value, implying a
true value if the flag is present and otherwise a false value. The
<tt class="docutils literal"><span class="pre">action='store_true'</span></tt> makes an option for such a flag.</p>
<p>Finally, the <tt class="docutils literal"><span class="pre">--dt</span></tt> option demonstrates how to allow for more than one
value (separated by blanks) through the <tt class="docutils literal"><span class="pre">nargs='+'</span></tt> keyword argument.
After the command line is parsed, we get an object where the values of
the options are stored as attributes. The attribute name is specified
by the <tt class="docutils literal"><span class="pre">dist</span></tt> keyword argument, which for the <tt class="docutils literal"><span class="pre">--dt</span></tt> option is
<tt class="docutils literal"><span class="pre">dt_values</span></tt>. Without the <tt class="docutils literal"><span class="pre">dest</span></tt> argument, the value of an option <tt class="docutils literal"><span class="pre">--opt</span></tt>
is stored as the attribute <tt class="docutils literal"><span class="pre">opt</span></tt>.</p>
<p>The code below demonstrates how to read the command line and extract
the values for each option:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">read_command_line</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">define_command_line_options</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;I={}, a={}, T={}, makeplot={}, dt_values={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">makeplot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dt_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">makeplot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dt_values</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">main</span></tt> function remains the same as in the <tt class="docutils literal"><span class="pre">decay_cml.py</span></tt> code based
on reading from <tt class="docutils literal"><span class="pre">sys.argv</span></tt> directly. A complete program featuring the
demo above of <tt class="docutils literal"><span class="pre">ArgumentParser</span></tt> appears in the file <a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_argparse.py">decay_argparse.py</a>.</p>
</div>
</div>
<div class="section" id="creating-a-graphical-web-user-interface">
<h2>Creating a graphical web user interface<a class="headerlink" href="#creating-a-graphical-web-user-interface" title="Permalink to this headline">¶</a></h2>
<p>The Python package <a class="reference external" href="https://github.com/hplgit/parampool">Parampool</a>
can be used to automatically generate a web-based <em>graphical user interface</em>
(GUI) for our simulation program. Although the programming technique
dramatically simplifies the efforts to create a GUI, the forthcoming
material on equipping our <tt class="docutils literal"><span class="pre">decay_mod</span></tt> module with a GUI is quite technical
and of significantly less importance than knowing how to make
a command-line interface (the section <em class="xref std std-ref">decay:commandline</em>).
There is no danger in jumping right to the section <a class="reference internal" href="#decay-convergence-rate"><em>Computing convergence rates</em></a>.</p>
<div class="section" id="making-a-compute-function">
<h3>Making a compute function<a class="headerlink" href="#making-a-compute-function" title="Permalink to this headline">¶</a></h3>
<p>The first step is to identify a function
that performs the computations and that takes the necessary input
variables as arguments. This is called the <em>compute function</em> in
Parampool terminology. We may start with a copy of the basic file
<a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_plot.py">decay_plot.py</a>,
which has a <tt class="docutils literal"><span class="pre">main</span></tt> function displayed in
the section <em class="xref std std-ref">decay:plotting</em> for carrying out simulations and plotting
for a series of <span class="math">\(\Delta t\)</span> values. Now we want to control and view the same
experiments from a web GUI.</p>
<p>To tell Parampool what type of input data we have,
we assign default values of the right type to all arguments in the
main function and call it <tt class="docutils literal"><span class="pre">main_GUI</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main_GUI</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
         <span class="n">dt_values</span><span class="o">=</span><span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
         <span class="n">theta_values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
</pre></div>
</div>
<p>The compute function must return the HTML code we want for displaying
the result in a web page. Here we want to show plots of the numerical
and exact solution for different methods and <span class="math">\(\Delta t\)</span> values.
The plots can be organized in a table with <span class="math">\(\theta\)</span> (methods) varying
through the columns and <span class="math">\(\Delta t\)</span> varying through the rows.
Assume now that a new version of the <tt class="docutils literal"><span class="pre">explore</span></tt> function
not only returns the error <tt class="docutils literal"><span class="pre">E</span></tt> but also HTML code containing the
plot. Then we can write the <tt class="docutils literal"><span class="pre">main_GUI</span></tt> function as</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main_GUI</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
         <span class="n">dt_values</span><span class="o">=</span><span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
         <span class="n">theta_values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="c"># Build HTML code for web page. Arrange plots in columns</span>
    <span class="c"># corresponding to the theta values, with dt down the rows</span>
    <span class="n">theta2name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;FE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;BE&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s">&#39;CN&#39;</span><span class="p">}</span>
    <span class="n">html_text</span> <span class="o">=</span> <span class="s">&#39;&lt;table&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
        <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&#39;&lt;tr&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">theta_values</span><span class="p">:</span>
            <span class="n">E</span><span class="p">,</span> <span class="n">html</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;td&gt;</span>
<span class="s">&lt;center&gt;&lt;b&gt;</span><span class="si">%s</span><span class="s">, dt=</span><span class="si">%g</span><span class="s">, error: </span><span class="si">%s</span><span class="s">&lt;/b&gt;&lt;/center&gt;&lt;br&gt;</span>
<span class="si">%s</span><span class="s"></span>
<span class="s">&lt;/td&gt;</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta2name</span><span class="p">[</span><span class="n">theta</span><span class="p">],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
        <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&#39;&lt;/tr&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&#39;&lt;/table&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">return</span> <span class="n">html_text</span>
</pre></div>
</div>
<p>Rather than creating plot files and showing the plot on the screen,
the new version of the <tt class="docutils literal"><span class="pre">explore</span></tt> function makes a string with the PNG code of
the plot and embeds that string in HTML code. This action is
conveniently performed by Parampool&#8217;s <tt class="docutils literal"><span class="pre">save_png_to_str</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">...</span>
<span class="c"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">r</span><span class="o">-</span><span class="s">&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">parampool.utils</span> <span class="kn">import</span> <span class="n">save_png_to_str</span>
<span class="n">html_text</span> <span class="o">=</span> <span class="n">save_png_to_str</span><span class="p">(</span><span class="n">plt</span><span class="p">,</span> <span class="n">plotwidth</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we now write <tt class="docutils literal"><span class="pre">plt.plot</span></tt>, <tt class="docutils literal"><span class="pre">plt.xlabel</span></tt>, etc.
The <tt class="docutils literal"><span class="pre">html_text</span></tt> string is long and contains all the characters that
build up the PNG file of the current plot. The new <tt class="docutils literal"><span class="pre">explore</span></tt>
function can make use of the above code snippet and return
<tt class="docutils literal"><span class="pre">html_text</span></tt> along with <tt class="docutils literal"><span class="pre">E</span></tt>.</p>
</div>
<div class="section" id="generating-the-user-interface">
<h3>Generating the user interface<a class="headerlink" href="#generating-the-user-interface" title="Permalink to this headline">¶</a></h3>
<p>The web GUI is automatically generated by
the following code, placed in a file <a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_GUI_generate.py">decay_GUI_generate.py</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">parampool.generator.flask</span> <span class="kn">import</span> <span class="n">generate</span>
<span class="kn">from</span> <span class="nn">decay_GUI</span> <span class="kn">import</span> <span class="n">main</span>
<span class="n">generate</span><span class="p">(</span><span class="n">main</span><span class="p">,</span>
         <span class="n">output_controller</span><span class="o">=</span><span class="s">&#39;decay_GUI_controller.py&#39;</span><span class="p">,</span>
         <span class="n">output_template</span><span class="o">=</span><span class="s">&#39;decay_GUI_view.py&#39;</span><span class="p">,</span>
         <span class="n">output_model</span><span class="o">=</span><span class="s">&#39;decay_GUI_model.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Running the <tt class="docutils literal"><span class="pre">decay_GUI_generate.py</span></tt> program results in three new
files whose names are specified in the call to <tt class="docutils literal"><span class="pre">generate</span></tt>:</p>
<blockquote>
<div><ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">decay_GUI_model.py</span></tt> defines HTML widgets to be used to set
input data in the web interface,</li>
<li><tt class="docutils literal"><span class="pre">templates/decay_GUI_views.py</span></tt> defines the layout of the web page,</li>
<li><tt class="docutils literal"><span class="pre">decay_GUI_controller.py</span></tt> runs the web application.</li>
</ol>
</div></blockquote>
<p>We only need to run the last program, and there is no need to look into
these files.</p>
</div>
<div class="section" id="running-the-web-application">
<h3>Running the web application<a class="headerlink" href="#running-the-web-application" title="Permalink to this headline">¶</a></h3>
<p>The web GUI is started by</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_GUI_controller.py
</pre></div>
</div>
<p>Open a web browser at the location <tt class="docutils literal"><span class="pre">127.0.0.1:5000</span></tt>. Input fields for
<tt class="docutils literal"><span class="pre">I</span></tt>, <tt class="docutils literal"><span class="pre">a</span></tt>, <tt class="docutils literal"><span class="pre">T</span></tt>, <tt class="docutils literal"><span class="pre">dt_values</span></tt>, and <tt class="docutils literal"><span class="pre">theta_values</span></tt> are presented.  Setting
the latter two to <tt class="docutils literal"><span class="pre">[1.25,</span> <span class="pre">0.5]</span></tt> and <tt class="docutils literal"><span class="pre">[1,</span> <span class="pre">0.5]</span></tt>, respectively, and
pressing <em>Compute</em> results in four plots, see Figure
<a class="reference internal" href="#decay-fig-gui"><em>Automatically generated graphical web interface</em></a>. With the techniques demonstrated here, one can
easily create a tailored web GUI for a particular type of application
and use it to interactively explore physical and numerical effects.</p>
<div class="figure" id="decay-fig-gui">
<a class="reference internal image-reference" href="_images/decay_GUI.png"><img alt="_images/decay_GUI.png" src="_images/decay_GUI.png" style="width: 800px;" /></a>
<p class="caption"><em>Automatically generated graphical web interface</em></p>
</div>
</div>
</div>
</div>
<div class="section" id="verification">
<h1>Verification<a class="headerlink" href="#verification" title="Permalink to this headline">¶</a></h1>
<div class="section" id="comparison-with-hand-calculations">
<h2>Comparison with hand calculations<a class="headerlink" href="#comparison-with-hand-calculations" title="Permalink to this headline">¶</a></h2>
<p>One of the simplest and most powerful methods for verifying numerical
codes is to perform some steps of the algorithm by hand and compare the
results with those produced by the code.
In the present case, we may choose some test problem and run three
steps by hand. Picking <span class="math">\(a(t)=t^2\)</span>...</p>
</div>
<div class="section" id="test-function">
<h2>Test function<a class="headerlink" href="#test-function" title="Permalink to this headline">¶</a></h2>
<div class="admonition-caution-choice-of-parameter-values admonition">
<p class="first admonition-title">Caution: choice of parameter values</p>
<p class="last">For the choice of values of parameters in verification tests one should
stay away from integers, especially 0 and 1, as these can
simplify formulas too much for test purposes. For example, with
<span class="math">\(\theta =1\)</span> the nominator in the formula for <span class="math">\(u^n\)</span> will be the same for
all <span class="math">\(a\)</span> and <span class="math">\(\Delta t\)</span> values. One should therefore choose more
&#8220;arbitrary&#8221; values, say <span class="math">\(\theta =0.8\)</span> and <span class="math">\(I=0.1\)</span>.</p>
</div>
</div>
<div class="section" id="comparison-with-an-exact-discrete-solution">
<h2>Comparison with an exact discrete solution<a class="headerlink" href="#comparison-with-an-exact-discrete-solution" title="Permalink to this headline">¶</a></h2>
<p>Sometimes it is possible to find a closed-form
<em>exact discrete solution</em> that fulfills the discrete finite
difference equations. The implementation can then be verified against
the exact discrete solution. This is usually the best technique for
verification.</p>
<p>Define</p>
<div class="math">
\[A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}{\thinspace .}\]</div>
<p>Manual computations with the <span class="math">\(\theta\)</span>-rule results in</p>
<div class="math">
\[\begin{split}u^0 &amp;= I,\\
u^1 &amp;= Au^0 = AI,\\
u^2 &amp;= Au^1 = A^2I,\\
&amp;\vdots\\
u^n &amp;= A^nu^{n-1} = A^nI {\thinspace .}\end{split}\]</div>
<p>We have then established the exact discrete solution as</p>
<div class="math" id="equation-decay:un:exact">
<span id="eq-decay-un-exact"></span><span class="eqno">(2)</span>\[     u^n = IA^n\]\[     {\thinspace .}\]</div>
<div class="admonition-caution admonition">
<p class="first admonition-title">Caution</p>
<p class="last">One should be conscious about the different meanings of the notation
on the left- and right-hand side
of <a href="#equation-decay:un:exact">(2)</a>: on the left, <span class="math">\(n\)</span> in <span class="math">\(u^n\)</span>
is a superscript reflecting a counter
of mesh points (<span class="math">\(t_n\)</span>), while on the right, <span class="math">\(n\)</span>
is the power in the exponentiation <span class="math">\(A^n\)</span>.</p>
</div>
<p>Comparison of the exact discrete solution and the computed
solution is done in the following function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">verify_exact_discrete_solution</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">A</span><span class="o">**</span><span class="n">n</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>  <span class="c"># no of steps</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">u_de</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c"># max deviation</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-15</span>  <span class="c"># tolerance for comparing floats</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">difference</span> <span class="o">&lt;=</span> <span class="n">tol</span>
    <span class="k">return</span> <span class="n">success</span>
</pre></div>
</div>
<p>The complete program is found in the file <a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_verf2.py">decay_verf2.py</a> (<tt class="docutils literal"><span class="pre">verf2</span></tt> is a short name for &#8220;verification,
version 2&#8221;).</p>
<div class="admonition-local-functions admonition">
<p class="first admonition-title">Local functions</p>
<p class="last">One can define a function inside another function, here called
a <em>local function</em> (also known as <em>closure</em>) inside a <em>parent function</em>.
A local function is invisible outside the parent function.
A convenient property is that any local function has access to all
variables defined in the parent function, also if we send the
local function to some other function as argument (!).
In the present example, it means that the local function
<tt class="docutils literal"><span class="pre">exact_discrete_solution</span></tt> does not need its five arguments as the
values can alternatively be accessed through the local variables defined
in the parent function <tt class="docutils literal"><span class="pre">verify_exact_discrete_solution</span></tt>. We can send
such an <tt class="docutils literal"><span class="pre">exact_discrete_solution</span></tt> without arguments to any other
function and <tt class="docutils literal"><span class="pre">exact_discrete_solution</span></tt> will still have access to
<tt class="docutils literal"><span class="pre">n</span></tt>, <tt class="docutils literal"><span class="pre">I</span></tt>, <tt class="docutils literal"><span class="pre">a</span></tt>, and so forth defined in its parent function.</p>
</div>
</div>
<div class="section" id="computing-convergence-rates">
<span id="decay-convergence-rate"></span><h2>Computing convergence rates<a class="headerlink" href="#computing-convergence-rates" title="Permalink to this headline">¶</a></h2>
<p id="index-10">We expect that the error <span class="math">\(E\)</span> in the numerical solution is
reduced if the mesh size <span class="math">\(\Delta t\)</span> is decreased. More specifically,
many numerical methods obey a power-law relation between <span class="math">\(E\)</span> and
<span class="math">\(\Delta t\)</span>:</p>
<div class="math" id="equation-decay:E:dt">
<span id="eq-decay-e-dt"></span><span class="eqno">(3)</span>\[     E = C\Delta t^r,\]</div>
<p>where <span class="math">\(C\)</span> and <span class="math">\(r\)</span> are (usually unknown) constants independent of <span class="math">\(\Delta t\)</span>.
The formula <a href="#equation-decay:E:dt">(3)</a> is viewed as an asymptotic model valid for
sufficiently small <span class="math">\(\Delta t\)</span>. How small is normally hard to estimate
without doing numerical estimations of <span class="math">\(r\)</span>.</p>
<p>The parameter <span class="math">\(r\)</span> is known as the <em>convergence rate</em>. For example,
if the convergence rate is 2, halving <span class="math">\(\Delta t\)</span> reduces the error by
a factor of 4. Diminishing <span class="math">\(\Delta t\)</span> then has a greater impact on
the error compared with methods that have <span class="math">\(r=1\)</span>. For a given value of <span class="math">\(r\)</span>,
we refer to the method as of <span class="math">\(r\)</span>-th order. First- and second-order
methods are most common in scientific computing.</p>
<div class="section" id="estimating">
<h3>Estimating <span class="math">\(r\)</span><a class="headerlink" href="#estimating" title="Permalink to this headline">¶</a></h3>
<p>There are two alternative ways of estimating <span class="math">\(C\)</span> and <span class="math">\(r\)</span> based on a set of
<span class="math">\(m\)</span> simulations with corresponding pairs <span class="math">\((\Delta t_i, E_i)\)</span>, <span class="math">\(i=0,\ldots,m-1\)</span>,
and <span class="math">\(\Delta t_{i} &lt; \Delta t_{i-1}\)</span> (i.e., decreasing cell size).</p>
<blockquote>
<div><ol class="arabic simple">
<li>Take the logarithm of <a href="#equation-decay:E:dt">(3)</a>, <span class="math">\(\ln E = r\ln \Delta t + \ln C\)</span>,
and fit a straight line to the data points <span class="math">\((\Delta t_i, E_i)\)</span>,
<span class="math">\(i=0,\ldots,m-1\)</span>.</li>
<li>Consider two consecutive experiments, <span class="math">\((\Delta t_i, E_i)\)</span> and
<span class="math">\((\Delta t_{i-1}, E_{i-1})\)</span>. Dividing the equation
<span class="math">\(E_{i-1}=C\Delta t_{i-1}^r\)</span> by <span class="math">\(E_{i}=C\Delta t_{i}^r\)</span> and solving
for <span class="math">\(r\)</span> yields</li>
</ol>
</div></blockquote>
<div class="math" id="equation-decay:conv:rate">
<span id="eq-decay-conv-rate"></span><span class="eqno">(4)</span>\[     r_{i-1} = \frac{\ln (E_{i-1}/E_i)}{\ln (\Delta t_{i-1}/\Delta t_i)}\]</div>
<p>for <span class="math">\(i=1,\ldots,m-1\)</span>.</p>
<p>The disadvantage of method 1 is that <a href="#equation-decay:E:dt">(3)</a> might not be valid
for the coarsest meshes (largest <span class="math">\(\Delta t\)</span> values). Fitting a line
to all the data points is then misleading.  Method 2 computes
convergence rates for pairs of experiments and allows us to see
if the sequence <span class="math">\(r_i\)</span> converges to some value as <span class="math">\(i\rightarrow m-2\)</span>.
The final <span class="math">\(r_{m-2}\)</span> can then be taken as the convergence rate.
If the coarsest meshes have a differing rate, the corresponding
time steps are probably too large for <a href="#equation-decay:E:dt">(3)</a> to be valid.
That is, those time steps lie outside the asymptotic range of
<span class="math">\(\Delta t\)</span> values where the error behaves like <a href="#equation-decay:E:dt">(3)</a>.</p>
</div>
<div class="section" id="implementation-2">
<h3>Implementation  (2)<a class="headerlink" href="#implementation-2" title="Permalink to this headline">¶</a></h3>
<p>It is straightforward to extend the <tt class="docutils literal"><span class="pre">main</span></tt> function in the program
<tt class="docutils literal"><span class="pre">decay_argparse.py</span></tt> with statements for computing <span class="math">\(r_0, r_1, \ldots, r_{m-2}\)</span>
from <a href="#equation-decay:E:dt">(3)</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">,</span> <span class="n">dt_values</span> <span class="o">=</span> <span class="n">read_command_line</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># estimated convergence rates</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">E_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">E_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="c"># Compute convergence rates</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt_values</span><span class="p">)</span>
        <span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">log</span><span class="p">(</span><span class="n">E_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">E_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">dt_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">dt_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Pairwise convergence rates for theta=</span><span class="si">%g</span><span class="s">:&#39;</span> <span class="o">%</span> <span class="n">theta</span>
        <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">r_</span> <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">r</span>
</pre></div>
</div>
<p>The program containing this <tt class="docutils literal"><span class="pre">main</span></tt> function is called <a class="reference external" href="http://tinyurl.com/nm5587k/softeng1/decay_convrate.py">decay_convrate.py</a>.</p>
<p id="index-11">The <tt class="docutils literal"><span class="pre">r</span></tt> object is a <em>dictionary of lists</em>. The keys in this
dictionary are the <span class="math">\(\theta\)</span> values. For example,
<tt class="docutils literal"><span class="pre">r[1]</span></tt> holds the list of the <span class="math">\(r_i\)</span> values corresponding to
<span class="math">\(\theta=1\)</span>. In the loop <tt class="docutils literal"><span class="pre">for</span> <span class="pre">theta</span> <span class="pre">in</span> <span class="pre">r</span></tt>, the loop variable <tt class="docutils literal"><span class="pre">theta</span></tt>
takes on the values of the keys in the dictionary <tt class="docutils literal"><span class="pre">r</span></tt> (in an
undetermined ordering). We could simply do a <tt class="docutils literal"><span class="pre">print</span> <span class="pre">r[theta]</span></tt>
inside the loop, but this would typically yield output of
the convergence rates with 16 decimals:</p>
<div class="highlight-text"><div class="highlight"><pre>[1.331919482274763, 1.1488178494691532, ...]
</pre></div>
</div>
<p>Instead, we format each number with 2 decimals, using a list
comprehension to turn the list of numbers, <tt class="docutils literal"><span class="pre">r[theta]</span></tt>, into
a list of formatted strings. Then we join these strings
with a space in between to get a sequence of rates on one line
in the terminal window. More generally, <tt class="docutils literal"><span class="pre">d.join(list)</span></tt> joins the
strings in the list <tt class="docutils literal"><span class="pre">list</span></tt> to one string, with <tt class="docutils literal"><span class="pre">d</span></tt>
as delimiter between <tt class="docutils literal"><span class="pre">list[0]</span></tt>, <tt class="docutils literal"><span class="pre">list[1]</span></tt>, etc.</p>
<p>Here is an example on the outcome of the convergence rate computations:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_convrate.py --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates for theta=0:
1.33 1.15 1.07 1.03 1.02

Pairwise convergence rates for theta=0.5:
2.14 2.07 2.03 2.01 2.01

Pairwise convergence rates for theta=1:
0.98 0.99 0.99 1.00 1.00
</pre></div>
</div>
<p>The Forward and Backward Euler methods seem to have an <span class="math">\(r\)</span> value which
stabilizes at 1, while the Crank-Nicolson seems to be a second-order
method with <span class="math">\(r=2\)</span>.</p>
<p id="index-12">Very often, we have some theory that predicts what <span class="math">\(r\)</span> is for a numerical
method. Various theoretical error measures for the <span class="math">\(\theta\)</span>-rule point to
<span class="math">\(r=2\)</span> for <span class="math">\(\theta =0.5\)</span> and <span class="math">\(r=1\)</span> otherwise. The computed estimates of <span class="math">\(r\)</span> are
in very good agreement with these theoretical values.</p>
<div class="admonition-why-convergence-rates-are-important admonition">
<p class="first admonition-title">Why convergence rates are important</p>
<p class="last">The strong practical application of computing convergence rates is for
verification: wrong convergence rates point to errors in the code, and
correct convergence rates brings evidence that the implementation is
correct. Experience shows that bugs in the code easily destroy the
expected convergence rate.</p>
</div>
</div>
<div class="section" id="debugging-via-convergence-rates">
<h3>Debugging via convergence rates<a class="headerlink" href="#debugging-via-convergence-rates" title="Permalink to this headline">¶</a></h3>
<p>Let us experiment with bugs and see the implication on the convergence
rate. We may, for instance, forget to multiply by <tt class="docutils literal"><span class="pre">a</span></tt> in the denominator
in the updating formula for <tt class="docutils literal"><span class="pre">u[n+1]</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
<p>Running the same <tt class="docutils literal"><span class="pre">decay_convrate.py</span></tt> command as above gives the expected
convergence rates (!). Why? The reason is that we just specified
the <span class="math">\(\Delta t\)</span> values are relied on default values for other
parameters. The default value of <span class="math">\(a\)</span> is 1. Forgetting the factor
<tt class="docutils literal"><span class="pre">a</span></tt> has then no effect. This example shows how important it is to
avoid parameters that are 1 or 0 when verifying implementations.
Running the code <tt class="docutils literal"><span class="pre">decay_v0.py</span></tt> with <span class="math">\(a=2.1\)</span> and <span class="math">\(I=0.1\)</span> yields</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_convrate.py --a 2.1 --I 0.1  \
          --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates for theta=0:
1.49 1.18 1.07 1.04 1.02

Pairwise convergence rates for theta=0.5:
-1.42 -0.22 -0.07 -0.03 -0.01

Pairwise convergence rates for theta=1:
0.21 0.12 0.06 0.03 0.01
</pre></div>
</div>
<p>This time we see that the expected convergence rates for the Crank-Nicolson and
Backward Euler methods are not obtained, while <span class="math">\(r=1\)</span> for the Forward Euler
method. The reason for correct rate in the latter case is that <span class="math">\(\theta=0\)</span>
and the wrong <tt class="docutils literal"><span class="pre">theta*dt</span></tt> term in the denominator vanishes anyway.</p>
<p>The error</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
<p>manifests itself through wrong rates <span class="math">\(r\approx 0\)</span> for all three methods.
About the same results arise from an erroneous initial condition, <tt class="docutils literal"><span class="pre">u[0]</span> <span class="pre">=</span> <span class="pre">1</span></tt>,
or wrong loop limits, <tt class="docutils literal"><span class="pre">range(1,Nt)</span></tt>. It seems that in this simple
problem, most bugs we can think of are detected by the convergence rate
test, provided the values of the input data do not hide the bug.</p>
<p>A <tt class="docutils literal"><span class="pre">verify_convergence_rate</span></tt> function could compute the dictionary of
list via <tt class="docutils literal"><span class="pre">main</span></tt> and check if the final rate estimates (<span class="math">\(r_{m-2}\)</span>)
are sufficiently close to the expected ones. A tolerance of 0.1
seems appropriate, given the uncertainty in estimating <span class="math">\(r\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">verify_convergence_rate</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">expected_rates</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">r_final</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected_rates</span><span class="p">[</span><span class="n">theta</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_final</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>  <span class="c"># all tests passed</span>
</pre></div>
</div>
<p>We remark that <tt class="docutils literal"><span class="pre">r[theta]</span></tt> is a list and the last element in any list
can be extracted by the index <tt class="docutils literal"><span class="pre">-1</span></tt>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <center>
            <p class="logo"><a href="http://cbc.simula.no/" title="Go to Center for Biomedical Computing">
              <img class="logo" src="_static/cbc_logo.png" alt="Logo"/>
            </a></p>
            </center>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Sample problem and code</a><ul>
<li><a class="reference internal" href="#mathematical-problem">Mathematical problem</a></li>
<li><a class="reference internal" href="#implementation-1">Implementation  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-interfaces">User interfaces</a><ul>
<li><a class="reference internal" href="#creating-command-line-interfaces">Creating command-line interfaces</a><ul>
<li><a class="reference internal" href="#reading-a-sequence-of-command-line-arguments">Reading a sequence of command-line arguments</a></li>
<li><a class="reference internal" href="#working-with-an-argument-parser">Working with an argument parser</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-a-graphical-web-user-interface">Creating a graphical web user interface</a><ul>
<li><a class="reference internal" href="#making-a-compute-function">Making a compute function</a></li>
<li><a class="reference internal" href="#generating-the-user-interface">Generating the user interface</a></li>
<li><a class="reference internal" href="#running-the-web-application">Running the web application</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#verification">Verification</a><ul>
<li><a class="reference internal" href="#comparison-with-hand-calculations">Comparison with hand calculations</a></li>
<li><a class="reference internal" href="#test-function">Test function</a></li>
<li><a class="reference internal" href="#comparison-with-an-exact-discrete-solution">Comparison with an exact discrete solution</a></li>
<li><a class="reference internal" href="#computing-convergence-rates">Computing convergence rates</a><ul>
<li><a class="reference internal" href="#estimating">Estimating <span class="math">\(r\)</span></a></li>
<li><a class="reference internal" href="#implementation-2">Implementation  (2)</a></li>
<li><a class="reference internal" href="#debugging-via-convergence-rates">Debugging via convergence rates</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._main_softeng1000.html"
                        title="previous chapter">Scientific software engineering with a simple ODE model as example</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="._main_softeng1002.html"
                        title="next chapter">Software engineering</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._main_softeng1001.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._main_softeng1002.html" title="Software engineering"
             >next</a> |</li>
        <li class="right" >
          <a href="._main_softeng1000.html" title="Scientific software engineering with a simple ODE model as example"
             >previous</a> |</li>
        <li><a href="index.html">Scientific software engineering with a simple ODE model as example</a> &raquo;</li> 
      </ul>
    </div>
<div class="wrapper">
  <div class="footer">
  <a href="http://cbc.simula.no"><img src="_static/cbc_banner.png" width="100%"><a>
  </div>
</div>

  </body>
</html>