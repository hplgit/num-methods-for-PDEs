

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Scientific software engineering for a simple ODE model</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Scientific software engineering for a simple ODE model" href="index.html" />
    <link rel="prev" title="Scientific software engineering for a simple ODE model" href="index.html" />
 
  
   <style type="text/css">
     div.admonition {
       background-color: whiteSmoke;
       border: 1px solid #bababa;
     }
   </style>
  </head>

  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="index.html" title="Scientific software engineering for a simple ODE model"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Scientific software engineering for a simple ODE model</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="scientific-software-engineering-for-a-simple-ode-model">
<h1>Scientific software engineering for a simple ODE model<a class="headerlink" href="#scientific-software-engineering-for-a-simple-ode-model" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Authors:</th><td class="field-body">Hans Petter Langtangen</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">Aug 18, 2014</td>
</tr>
</tbody>
</table>
<div class="admonition-goal admonition">
<p class="first admonition-title">Goal</p>
<p>This document illustrates <em>best practice</em> for developing scientific software
in an efficient and reliable way. Not only will the outlined techniques
save a lost of human time, but they will also help assure reproducible science
and higher quality of computational investigations. Key questions to
be answered are</p>
<blockquote class="last">
<div><ul class="simple">
<li>How should I organize a program?</li>
<li>How can I efficiently and safely provide input data and run my code?</li>
<li>How can I verify that the implementation is correct?</li>
<li>How should I reliably work with files and documents?</li>
<li>How should I conduct large numerical experiments?</li>
</ul>
</div></blockquote>
</div>
<p>[<strong>hpl 1</strong>: Need to cover functions, classes, modules, cml, GUI, hand calc, trivial problems, exact num sol, MMS, qualitative results, Git, bitbucket/github, scripting, report generation]</p>
<div class="section" id="sample-problem-and-code">
<h2>Sample problem and code<a class="headerlink" href="#sample-problem-and-code" title="Permalink to this headline">¶</a></h2>
<p>This first introduction to good programming habits in scientific
computing will make use of a very simple mathematical problem to keep
the mathematical details at the lowest possible level while
introducing a series of computer science concepts. The simplicity of
the mathematical problem obviously prevents us from treating several
techniques that are only meaningful for complex scientific software.</p>
<div class="section" id="mathematical-problem">
<h3>Mathematical problem<a class="headerlink" href="#mathematical-problem" title="Permalink to this headline">¶</a></h3>
<p>We consider the simplest possible ordinary differential equation
with constant coefficient <span class="math">\(a\)</span>:</p>
<div class="math" id="equation-softeng1:problem:ode">
<span class="eqno">(1)</span>\[     u'(t) = -au(t),\quad u(0)=I,\quad t\in (0,T]{\thinspace .}\]</div>
<p>This problem is numerically solved by the so-called <span class="math">\(\theta\)</span>-rule,
which is a convenient way to merge different formulas for the
well-known Forward Euler, Backward Euler, and Crank-Nicolson
(midpoint/central) schemes. We introduce a uniform time mesh
<span class="math">\(t_n=n\Delta t\)</span>, <span class="math">\(n=0,1,\ldots,N_t\)</span>, and seek <span class="math">\(u(t)\)</span> at the mesh
points. The numerical approximation to <span class="math">\(u(t_n)\)</span> is denoted
<span class="math">\(u^n\)</span>. Since we will use the symbol <span class="math">\(u\)</span> both for the exact analytical
solution of <a href="#equation-softeng1:problem:ode">(1)</a> and for the numerical
approximation, we sometimes introduce <span class="math">\({u_{\small\mbox{e}}}(t)\)</span> to help distinguish
the two types of solutions (i.e., subscript e for &#8220;exact&#8221;) <a class="footnote-reference" href="#e-subscript" id="id1">[1]</a>.</p>
<table class="docutils footnote" frame="void" id="e-subscript" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>In the literature, it is more common to put a subscript
(like <span class="math">\(u_\Delta\)</span> or <span class="math">\(u_h\)</span>)
on the numerical solution to distinguish it from the exact solution.
However, we will use the variable <tt class="docutils literal"><span class="pre">u</span></tt> in the code for the numerical
approximation to be computed, and therefore adjust the mathematical
notation to convenient conventions in the code such that we can have
as close correspondence as possible between the implementation and
the mathematics.</td></tr>
</tbody>
</table>
<p>The <span class="math">\(\theta\)</span>-rule leads to an explicit updating formula for <span class="math">\(u^{n+1}\)</span>,
given <span class="math">\(u^n\)</span>:</p>
<div class="math">
\[u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,\]</div>
</div>
<div class="section" id="implementation-1">
<h3>Implementation  (1)<a class="headerlink" href="#implementation-1" title="Permalink to this headline">¶</a></h3>
<p>The numerical method is implemented as a function <tt class="docutils literal"><span class="pre">solver</span></tt>.
Another function <tt class="docutils literal"><span class="pre">explore</span></tt> computes the error in the solution,
by comparing with the exact solution <span class="math">\({u_{\small\mbox{e}}}(t)=Ie^{-at}\)</span>,
and creates a plot for comparing the numerical and exact solution.</p>
<p>The program file
<a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_plot.py">decay_plot.py</a> contains the two
functions and a main program.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.&quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>            <span class="c"># avoid integer division</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>     <span class="c"># no of time intervals</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span>                 <span class="c"># adjust T to fit time step dt</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>           <span class="c"># array of u[n] values</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># time mesh</span>

    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>                  <span class="c"># assign initial condition</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="p">):</span>    <span class="c"># n=0,1,...,Nt-1</span>
        <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">t</span>

<span class="k">def</span> <span class="nf">exact_solution</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a case with the solver, compute error measure,</span>
<span class="sd">    and plot the numerical and exact solutions (if makeplot=True).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>    <span class="c"># Numerical solution</span>
    <span class="n">u_e</span> <span class="o">=</span> <span class="n">exact_solution</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">u_e</span> <span class="o">-</span> <span class="n">u</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">makeplot</span><span class="p">:</span>
        <span class="n">figure</span><span class="p">()</span>                         <span class="c"># create new plot</span>
        <span class="n">t_e</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>       <span class="c"># fine mesh for u_e</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="n">exact_solution</span><span class="p">(</span><span class="n">t_e</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span>   <span class="n">u</span><span class="p">,</span>   <span class="s">&#39;r--o&#39;</span><span class="p">)</span>           <span class="c"># red dashes w/circles</span>
        <span class="n">plot</span><span class="p">(</span><span class="n">t_e</span><span class="p">,</span> <span class="n">u_e</span><span class="p">,</span> <span class="s">&#39;b-&#39;</span><span class="p">)</span>             <span class="c"># blue line for exact sol.</span>
        <span class="n">legend</span><span class="p">([</span><span class="s">&#39;numerical&#39;</span><span class="p">,</span> <span class="s">&#39;exact&#39;</span><span class="p">])</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">title</span><span class="p">(</span><span class="s">&#39;theta=</span><span class="si">%g</span><span class="s">, dt=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">theta2name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;FE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;BE&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s">&#39;CN&#39;</span><span class="p">}</span>
        <span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%g</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta2name</span><span class="p">[</span><span class="n">theta</span><span class="p">],</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%g</span><span class="s">.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta2name</span><span class="p">[</span><span class="n">theta</span><span class="p">],</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">E</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt_values</span><span class="p">,</span> <span class="n">theta_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">theta_values</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%6.2f</span><span class="s">: </span><span class="si">%12.3E</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>

<span class="n">main</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dt_values</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="user-interfaces">
<h2>User interfaces<a class="headerlink" href="#user-interfaces" title="Permalink to this headline">¶</a></h2>
<p>It is good programming practice to let programs read input from the
user rather than require the user to edit the source code when trying
out new values of input parameters. One reason is that any edit of the
code has a danger of introducing bugs. Another reason is that it is
easier and less manual work to supply data to a program instead of
editing the program code. A third reason is that a program that reads
input can easily be run by another program, and in this way we can
automate a large number of runs in scientific investigations.</p>
<div class="admonition-tip admonition">
<p class="first admonition-title">Tip</p>
<p class="last">We shall make it a habit to equip any implementation of a
numerical solver with an appropriate user interface before testing out
the code.</p>
</div>
<p>Reading input data can be done in many ways. We have to decide on
desired <em>user interface</em>, i.e., how we want to operate the program
when providing input, and then use appropriate tools to implement
the user interface. There are four basic types of user interface
of relevance to our programs, listed here with increasing complexity
of the implementation:</p>
<ol class="arabic simple">
<li>Questions and answers in the terminal window</li>
<li>Command-line arguments</li>
<li>Reading data from file</li>
<li>Graphical user interfaces</li>
</ol>
<p>Although conceptually simple, alternative 1 involves more typing than
the other alternatives and is therefore abandoned. Below, we shall
address alternative 2 and 4, which are most appropriate for the
present problem.</p>
<p>[[[
.. _decay:commandline:</p>
<div class="section" id="creating-command-line-interfaces">
<h3>Creating command-line interfaces<a class="headerlink" href="#creating-command-line-interfaces" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-0"></span><p id="index-1">Reading input from the command line is a simple and flexible way of interacting
with the user. Python stores all the command-line arguments in
the list <tt class="docutils literal"><span class="pre">sys.argv</span></tt>, and there are, in principle, two ways of programming with
command-line arguments in Python:</p>
<blockquote>
<div><ul class="simple">
<li>Decide upon a sequence of parameters on the command line and read
their values directly from the <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt> list (<tt class="docutils literal"><span class="pre">sys.argv[0]</span></tt> is
the just program name).</li>
<li>Use option-value pairs (<tt class="docutils literal"><span class="pre">--option</span> <span class="pre">value</span></tt>) on
the command line to override default values of input parameters,
and utilize the <tt class="docutils literal"><span class="pre">argparse.ArgumentParser</span></tt> tool to interact with
the command line.</li>
</ul>
</div></blockquote>
<p>Both strategies will be illustrated next.</p>
<div class="section" id="reading-a-sequence-of-command-line-arguments">
<h4>Reading a sequence of command-line arguments<a class="headerlink" href="#reading-a-sequence-of-command-line-arguments" title="Permalink to this headline">¶</a></h4>
<p id="index-2">The <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_plot.py">decay_plot.py</a>
program needs the following input data: <span class="math">\(I\)</span>, <span class="math">\(a\)</span>, <span class="math">\(T\)</span>, an option to
turn the plot on or off (<tt class="docutils literal"><span class="pre">makeplot</span></tt>), and a list of <span class="math">\(\Delta t\)</span> values.</p>
<p>The simplest way of reading this input from the command line is to say
that the first four command-line arguments correspond to the first
four points in the list above, in that order, and that the rest of the
command-line arguments are the <span class="math">\(\Delta t\)</span> values.  The input given for
<tt class="docutils literal"><span class="pre">makeplot</span></tt> can be a string among <tt class="docutils literal"><span class="pre">'on'</span></tt>, <tt class="docutils literal"><span class="pre">'off'</span></tt>, <tt class="docutils literal"><span class="pre">'True'</span></tt>, and
<tt class="docutils literal"><span class="pre">'False'</span></tt>. The code for reading this input is most conveniently put in
a function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">read_command_line</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Usage: </span><span class="si">%s</span><span class="s"> I a T on/off dt1 dt2 dt3 ...&#39;</span> <span class="o">%</span> \
              <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># abort</span>

    <span class="n">I</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">makeplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;True&#39;</span><span class="p">)</span>
    <span class="n">dt_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">:]]</span>

    <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">,</span> <span class="n">dt_values</span>
</pre></div>
</div>
<span class="target" id="index-3"></span><p id="index-4">One should note the following about the constructions in the program above:</p>
<blockquote>
<div><ul class="simple">
<li>Everything on the command line ends up in a <em>string</em> in
the list <tt class="docutils literal"><span class="pre">sys.argv</span></tt>. Explicit conversion to, e.g., a <tt class="docutils literal"><span class="pre">float</span></tt> object is
required if the string as a number we want to compute with.</li>
<li>The value of <tt class="docutils literal"><span class="pre">makeplot</span></tt> is determined from a boolean expression,
which becomes <tt class="docutils literal"><span class="pre">True</span></tt> if the command-line argument is either <tt class="docutils literal"><span class="pre">'on'</span></tt> or
<tt class="docutils literal"><span class="pre">'True'</span></tt>, and <tt class="docutils literal"><span class="pre">False</span></tt> otherwise.</li>
<li>It is easy to build the list of <span class="math">\(\Delta t\)</span> values: we simply run through
the rest of the list, <tt class="docutils literal"><span class="pre">sys.argv[5:]</span></tt>, convert each command-line argument
to <tt class="docutils literal"><span class="pre">float</span></tt>, and collect these <tt class="docutils literal"><span class="pre">float</span></tt> objects in a list, using the
compact and convenient <em>list comprehension</em> syntax in Python.</li>
</ul>
</div></blockquote>
<p>The loops over <span class="math">\(\theta\)</span> and <span class="math">\(\Delta t\)</span> values can be coded in a <tt class="docutils literal"><span class="pre">main</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">,</span> <span class="n">dt_values</span> <span class="o">=</span> <span class="n">read_command_line</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%6.2f</span><span class="s">: </span><span class="si">%12.3E</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
</pre></div>
</div>
<p>The complete program can be found in <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_cml.py">decay_cml.py</a>.</p>
</div>
<div class="section" id="working-with-an-argument-parser">
<h4>Working with an argument parser<a class="headerlink" href="#working-with-an-argument-parser" title="Permalink to this headline">¶</a></h4>
<span class="target" id="index-5"></span><span class="target" id="index-6"></span><span class="target" id="index-7"></span><span class="target" id="index-8"></span><p id="index-9">Python&#8217;s <tt class="docutils literal"><span class="pre">ArgumentParser</span></tt> tool in the <tt class="docutils literal"><span class="pre">argparse</span></tt> module makes it easy
to create a professional command-line interface to any program. The
documentation of <a class="reference external" href="http://docs.python.org/library/argparse.html">ArgumentParser</a> demonstrates its
versatile applications, so we shall here just list an example
containing basic features.  On the command line we want to specify
option-value pairs for <span class="math">\(I\)</span>, <span class="math">\(a\)</span>, and <span class="math">\(T\)</span>, e.g., <tt class="docutils literal"><span class="pre">--a</span> <span class="pre">3.5</span> <span class="pre">--I</span> <span class="pre">2</span> <span class="pre">--T</span>
<span class="pre">2</span></tt>. Including <tt class="docutils literal"><span class="pre">--makeplot</span></tt> turns the plot on and excluding this option
turns the plot off.  The <span class="math">\(\Delta t\)</span> values can be given as <tt class="docutils literal"><span class="pre">--dt</span> <span class="pre">1</span> <span class="pre">0.5</span>
<span class="pre">0.25</span> <span class="pre">0.1</span> <span class="pre">0.01</span></tt>.  Each parameter must have a sensible default value so
that we specify the option on the command line only when the default
value is not suitable.</p>
<p>We introduce a function for defining the mentioned command-line options:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">define_command_line_options</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--I&#39;</span><span class="p">,</span> <span class="s">&#39;--initial_condition&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;initial condition, u(0)&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;I&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--a&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;coefficient in ODE&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--T&#39;</span><span class="p">,</span> <span class="s">&#39;--stop_time&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;end time of simulation&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--makeplot&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;display plot or not&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--dt&#39;</span><span class="p">,</span> <span class="s">&#39;--time_step_values&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;time step values&#39;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;dt&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dt_values&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>
</pre></div>
</div>
<p>Each command-line option is defined through the <tt class="docutils literal"><span class="pre">parser.add_argument</span></tt>
method. Alternative options, like the short <tt class="docutils literal"><span class="pre">--I</span></tt> and the more
explaining version <tt class="docutils literal"><span class="pre">--initial_condition</span></tt> can be defined. Other arguments
are <tt class="docutils literal"><span class="pre">type</span></tt> for the Python object type, a default value, and a help
string, which gets printed if the command-line argument <tt class="docutils literal"><span class="pre">-h</span></tt> or <tt class="docutils literal"><span class="pre">--help</span></tt> is
included. The <tt class="docutils literal"><span class="pre">metavar</span></tt> argument specifies the value associated with
the option when the help string is printed. For example, the option for
<span class="math">\(I\)</span> has this help output:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_argparse.py -h
  ...
  --I I, --initial_condition I
                        initial condition, u(0)
  ...
</pre></div>
</div>
<p>The structure of this output is</p>
<div class="highlight-text"><div class="highlight"><pre>--I metavar, --initial_condition metavar
                      help-string
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">--makeplot</span></tt> option is a pure flag without any value, implying a
true value if the flag is present and otherwise a false value. The
<tt class="docutils literal"><span class="pre">action='store_true'</span></tt> makes an option for such a flag.</p>
<p>Finally, the <tt class="docutils literal"><span class="pre">--dt</span></tt> option demonstrates how to allow for more than one
value (separated by blanks) through the <tt class="docutils literal"><span class="pre">nargs='+'</span></tt> keyword argument.
After the command line is parsed, we get an object where the values of
the options are stored as attributes. The attribute name is specified
by the <tt class="docutils literal"><span class="pre">dist</span></tt> keyword argument, which for the <tt class="docutils literal"><span class="pre">--dt</span></tt> option is
<tt class="docutils literal"><span class="pre">dt_values</span></tt>. Without the <tt class="docutils literal"><span class="pre">dest</span></tt> argument, the value of an option <tt class="docutils literal"><span class="pre">--opt</span></tt>
is stored as the attribute <tt class="docutils literal"><span class="pre">opt</span></tt>.</p>
<p>The code below demonstrates how to read the command line and extract
the values for each option:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">read_command_line</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">define_command_line_options</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;I={}, a={}, T={}, makeplot={}, dt_values={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">makeplot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dt_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">makeplot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dt_values</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">main</span></tt> function remains the same as in the <tt class="docutils literal"><span class="pre">decay_cml.py</span></tt> code based
on reading from <tt class="docutils literal"><span class="pre">sys.argv</span></tt> directly. A complete program featuring the
demo above of <tt class="docutils literal"><span class="pre">ArgumentParser</span></tt> appears in the file <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_argparse.py">decay_argparse.py</a>.</p>
</div>
</div>
<div class="section" id="creating-a-graphical-web-user-interface">
<h3>Creating a graphical web user interface<a class="headerlink" href="#creating-a-graphical-web-user-interface" title="Permalink to this headline">¶</a></h3>
<p>The Python package <a class="reference external" href="https://github.com/hplgit/parampool">Parampool</a>
can be used to automatically generate a web-based <em>graphical user interface</em>
(GUI) for our simulation program. Although the programming technique
dramatically simplifies the efforts to create a GUI, the forthcoming
material on equipping our <tt class="docutils literal"><span class="pre">decay_mod</span></tt> module with a GUI is quite technical
and of significantly less importance than knowing how to make
a command-line interface (the section <em class="xref std std-ref">decay:commandline</em>).
There is no danger in jumping right to the section <a class="reference internal" href="#decay-convergence-rate"><em>Computing convergence rates</em></a>.</p>
<div class="section" id="making-a-compute-function">
<h4>Making a compute function<a class="headerlink" href="#making-a-compute-function" title="Permalink to this headline">¶</a></h4>
<p>The first step is to identify a function
that performs the computations and that takes the necessary input
variables as arguments. This is called the <em>compute function</em> in
Parampool terminology. We may start with a copy of the basic file
<a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_plot.py">decay_plot.py</a>,
which has a <tt class="docutils literal"><span class="pre">main</span></tt> function displayed in
the section <em class="xref std std-ref">decay:plotting</em> for carrying out simulations and plotting
for a series of <span class="math">\(\Delta t\)</span> values. Now we want to control and view the same
experiments from a web GUI.</p>
<p>To tell Parampool what type of input data we have,
we assign default values of the right type to all arguments in the
main function and call it <tt class="docutils literal"><span class="pre">main_GUI</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main_GUI</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
         <span class="n">dt_values</span><span class="o">=</span><span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
         <span class="n">theta_values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
</pre></div>
</div>
<p>The compute function must return the HTML code we want for displaying
the result in a web page. Here we want to show plots of the numerical
and exact solution for different methods and <span class="math">\(\Delta t\)</span> values.
The plots can be organized in a table with <span class="math">\(\theta\)</span> (methods) varying
through the columns and <span class="math">\(\Delta t\)</span> varying through the rows.
Assume now that a new version of the <tt class="docutils literal"><span class="pre">explore</span></tt> function
not only returns the error <tt class="docutils literal"><span class="pre">E</span></tt> but also HTML code containing the
plot. Then we can write the <tt class="docutils literal"><span class="pre">main_GUI</span></tt> function as</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main_GUI</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
         <span class="n">dt_values</span><span class="o">=</span><span class="p">[</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
         <span class="n">theta_values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="c"># Build HTML code for web page. Arrange plots in columns</span>
    <span class="c"># corresponding to the theta values, with dt down the rows</span>
    <span class="n">theta2name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;FE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;BE&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s">&#39;CN&#39;</span><span class="p">}</span>
    <span class="n">html_text</span> <span class="o">=</span> <span class="s">&#39;&lt;table&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
        <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&#39;&lt;tr&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">theta_values</span><span class="p">:</span>
            <span class="n">E</span><span class="p">,</span> <span class="n">html</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;td&gt;</span>
<span class="s">&lt;center&gt;&lt;b&gt;</span><span class="si">%s</span><span class="s">, dt=</span><span class="si">%g</span><span class="s">, error: </span><span class="si">%s</span><span class="s">&lt;/b&gt;&lt;/center&gt;&lt;br&gt;</span>
<span class="si">%s</span><span class="s"></span>
<span class="s">&lt;/td&gt;</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta2name</span><span class="p">[</span><span class="n">theta</span><span class="p">],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
        <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&#39;&lt;/tr&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">html_text</span> <span class="o">+=</span> <span class="s">&#39;&lt;/table&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">return</span> <span class="n">html_text</span>
</pre></div>
</div>
<p>Rather than creating plot files and showing the plot on the screen,
the new version of the <tt class="docutils literal"><span class="pre">explore</span></tt> function makes a string with the PNG code of
the plot and embeds that string in HTML code. This action is
conveniently performed by Parampool&#8217;s <tt class="docutils literal"><span class="pre">save_png_to_str</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">...</span>
<span class="c"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">r</span><span class="o">-</span><span class="s">&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">parampool.utils</span> <span class="kn">import</span> <span class="n">save_png_to_str</span>
<span class="n">html_text</span> <span class="o">=</span> <span class="n">save_png_to_str</span><span class="p">(</span><span class="n">plt</span><span class="p">,</span> <span class="n">plotwidth</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we now write <tt class="docutils literal"><span class="pre">plt.plot</span></tt>, <tt class="docutils literal"><span class="pre">plt.xlabel</span></tt>, etc.
The <tt class="docutils literal"><span class="pre">html_text</span></tt> string is long and contains all the characters that
build up the PNG file of the current plot. The new <tt class="docutils literal"><span class="pre">explore</span></tt>
function can make use of the above code snippet and return
<tt class="docutils literal"><span class="pre">html_text</span></tt> along with <tt class="docutils literal"><span class="pre">E</span></tt>.</p>
</div>
<div class="section" id="generating-the-user-interface">
<h4>Generating the user interface<a class="headerlink" href="#generating-the-user-interface" title="Permalink to this headline">¶</a></h4>
<p>The web GUI is automatically generated by
the following code, placed in a file <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_GUI_generate.py">decay_GUI_generate.py</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">parampool.generator.flask</span> <span class="kn">import</span> <span class="n">generate</span>
<span class="kn">from</span> <span class="nn">decay_GUI</span> <span class="kn">import</span> <span class="n">main</span>
<span class="n">generate</span><span class="p">(</span><span class="n">main</span><span class="p">,</span>
         <span class="n">output_controller</span><span class="o">=</span><span class="s">&#39;decay_GUI_controller.py&#39;</span><span class="p">,</span>
         <span class="n">output_template</span><span class="o">=</span><span class="s">&#39;decay_GUI_view.py&#39;</span><span class="p">,</span>
         <span class="n">output_model</span><span class="o">=</span><span class="s">&#39;decay_GUI_model.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Running the <tt class="docutils literal"><span class="pre">decay_GUI_generate.py</span></tt> program results in three new
files whose names are specified in the call to <tt class="docutils literal"><span class="pre">generate</span></tt>:</p>
<blockquote>
<div><ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">decay_GUI_model.py</span></tt> defines HTML widgets to be used to set
input data in the web interface,</li>
<li><tt class="docutils literal"><span class="pre">templates/decay_GUI_views.py</span></tt> defines the layout of the web page,</li>
<li><tt class="docutils literal"><span class="pre">decay_GUI_controller.py</span></tt> runs the web application.</li>
</ol>
</div></blockquote>
<p>We only need to run the last program, and there is no need to look into
these files.</p>
</div>
<div class="section" id="running-the-web-application">
<h4>Running the web application<a class="headerlink" href="#running-the-web-application" title="Permalink to this headline">¶</a></h4>
<p>The web GUI is started by</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_GUI_controller.py
</pre></div>
</div>
<p>Open a web browser at the location <tt class="docutils literal"><span class="pre">127.0.0.1:5000</span></tt>. Input fields for
<tt class="docutils literal"><span class="pre">I</span></tt>, <tt class="docutils literal"><span class="pre">a</span></tt>, <tt class="docutils literal"><span class="pre">T</span></tt>, <tt class="docutils literal"><span class="pre">dt_values</span></tt>, and <tt class="docutils literal"><span class="pre">theta_values</span></tt> are presented.  Setting
the latter two to <tt class="docutils literal"><span class="pre">[1.25,</span> <span class="pre">0.5]</span></tt> and <tt class="docutils literal"><span class="pre">[1,</span> <span class="pre">0.5]</span></tt>, respectively, and
pressing <em>Compute</em> results in four plots, see Figure
<a class="reference internal" href="#decay-fig-gui"><em>Automatically generated graphical web interface</em></a>. With the techniques demonstrated here, one can
easily create a tailored web GUI for a particular type of application
and use it to interactively explore physical and numerical effects.</p>
<div class="figure" id="decay-fig-gui">
<a class="reference internal image-reference" href="_images/decay_GUI.png"><img alt="_images/decay_GUI.png" src="_images/decay_GUI.png" style="width: 800px;" /></a>
<p class="caption"><em>Automatically generated graphical web interface</em></p>
</div>
</div>
</div>
</div>
<div class="section" id="verification">
<h2>Verification<a class="headerlink" href="#verification" title="Permalink to this headline">¶</a></h2>
<div class="section" id="comparison-with-hand-calculations">
<h3>Comparison with hand calculations<a class="headerlink" href="#comparison-with-hand-calculations" title="Permalink to this headline">¶</a></h3>
<p>One of the simplest and most powerful methods for verifying numerical
codes is to perform some steps of the algorithm by hand and compare the
results with those produced by the code.
In the present case, we may choose some test problem and run three
steps by hand. Picking <span class="math">\(a(t)=t^2\)</span>... [<strong>hpl 2</strong>: Not ready. Time-dep <span class="math">\(a\)</span>?]</p>
</div>
<div class="section" id="test-function">
<h3>Test function<a class="headerlink" href="#test-function" title="Permalink to this headline">¶</a></h3>
<div class="admonition-caution-choice-of-parameter-values admonition">
<p class="first admonition-title">Caution: choice of parameter values</p>
<p class="last">For the choice of values of parameters in verification tests one should
stay away from integers, especially 0 and 1, as these can
simplify formulas too much for test purposes. For example, with
<span class="math">\(\theta =1\)</span> the nominator in the formula for <span class="math">\(u^n\)</span> will be the same for
all <span class="math">\(a\)</span> and <span class="math">\(\Delta t\)</span> values. One should therefore choose more
&#8220;arbitrary&#8221; values, say <span class="math">\(\theta =0.8\)</span> and <span class="math">\(I=0.1\)</span>.</p>
</div>
</div>
<div class="section" id="comparison-with-an-exact-discrete-solution">
<h3>Comparison with an exact discrete solution<a class="headerlink" href="#comparison-with-an-exact-discrete-solution" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is possible to find a closed-form
<em>exact discrete solution</em> that fulfills the discrete finite
difference equations. The implementation can then be verified against
the exact discrete solution. This is usually the best technique for
verification.</p>
<p>Define</p>
<div class="math">
\[A = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a \Delta t}{\thinspace .}\]</div>
<p>Manual computations with the <span class="math">\(\theta\)</span>-rule results in</p>
<div class="math">
\[\begin{split}u^0 &amp;= I,\\
u^1 &amp;= Au^0 = AI,\\
u^2 &amp;= Au^1 = A^2I,\\
&amp;\vdots\\
u^n &amp;= A^nu^{n-1} = A^nI {\thinspace .}\end{split}\]</div>
<p>We have then established the exact discrete solution as</p>
<div class="math" id="equation-decay:un:exact">
<span class="eqno">(2)</span>\[     u^n = IA^n\]\[     {\thinspace .}\]</div>
<div class="admonition-caution admonition">
<p class="first admonition-title">Caution</p>
<p class="last">One should be conscious about the different meanings of the notation
on the left- and right-hand side
of <a href="#equation-decay:un:exact">(2)</a>: on the left, <span class="math">\(n\)</span> in <span class="math">\(u^n\)</span>
is a superscript reflecting a counter
of mesh points (<span class="math">\(t_n\)</span>), while on the right, <span class="math">\(n\)</span>
is the power in the exponentiation <span class="math">\(A^n\)</span>.</p>
</div>
<p>Comparison of the exact discrete solution and the computed
solution is done in the following function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">verify_exact_discrete_solution</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">A</span><span class="o">**</span><span class="n">n</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>  <span class="c"># no of steps</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">u_de</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c"># max deviation</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1E-15</span>  <span class="c"># tolerance for comparing floats</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">difference</span> <span class="o">&lt;=</span> <span class="n">tol</span>
    <span class="k">return</span> <span class="n">success</span>
</pre></div>
</div>
<p>The complete program is found in the file <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_verf2.py">decay_verf2.py</a> (<tt class="docutils literal"><span class="pre">verf2</span></tt> is a short name for &#8220;verification,
version 2&#8221;).</p>
<div class="admonition-local-functions admonition">
<p class="first admonition-title">Local functions</p>
<p class="last">One can define a function inside another function, here called
a <em>local function</em> (also known as <em>closure</em>) inside a <em>parent function</em>.
A local function is invisible outside the parent function.
A convenient property is that any local function has access to all
variables defined in the parent function, also if we send the
local function to some other function as argument (!).
In the present example, it means that the local function
<tt class="docutils literal"><span class="pre">exact_discrete_solution</span></tt> does not need its five arguments as the
values can alternatively be accessed through the local variables defined
in the parent function <tt class="docutils literal"><span class="pre">verify_exact_discrete_solution</span></tt>. We can send
such an <tt class="docutils literal"><span class="pre">exact_discrete_solution</span></tt> without arguments to any other
function and <tt class="docutils literal"><span class="pre">exact_discrete_solution</span></tt> will still have access to
<tt class="docutils literal"><span class="pre">n</span></tt>, <tt class="docutils literal"><span class="pre">I</span></tt>, <tt class="docutils literal"><span class="pre">a</span></tt>, and so forth defined in its parent function.</p>
</div>
</div>
<div class="section" id="computing-convergence-rates">
<span id="decay-convergence-rate"></span><h3>Computing convergence rates<a class="headerlink" href="#computing-convergence-rates" title="Permalink to this headline">¶</a></h3>
<p id="index-10">We expect that the error <span class="math">\(E\)</span> in the numerical solution is
reduced if the mesh size <span class="math">\(\Delta t\)</span> is decreased. More specifically,
many numerical methods obey a power-law relation between <span class="math">\(E\)</span> and
<span class="math">\(\Delta t\)</span>:</p>
<div class="math" id="equation-decay:E:dt">
<span class="eqno">(3)</span>\[     E = C\Delta t^r,\]</div>
<p>where <span class="math">\(C\)</span> and <span class="math">\(r\)</span> are (usually unknown) constants independent of <span class="math">\(\Delta t\)</span>.
The formula <a href="#equation-decay:E:dt">(3)</a> is viewed as an asymptotic model valid for
sufficiently small <span class="math">\(\Delta t\)</span>. How small is normally hard to estimate
without doing numerical estimations of <span class="math">\(r\)</span>.</p>
<p>The parameter <span class="math">\(r\)</span> is known as the <em>convergence rate</em>. For example,
if the convergence rate is 2, halving <span class="math">\(\Delta t\)</span> reduces the error by
a factor of 4. Diminishing <span class="math">\(\Delta t\)</span> then has a greater impact on
the error compared with methods that have <span class="math">\(r=1\)</span>. For a given value of <span class="math">\(r\)</span>,
we refer to the method as of <span class="math">\(r\)</span>-th order. First- and second-order
methods are most common in scientific computing.</p>
<div class="section" id="estimating">
<h4>Estimating <span class="math">\(r\)</span><a class="headerlink" href="#estimating" title="Permalink to this headline">¶</a></h4>
<p>There are two alternative ways of estimating <span class="math">\(C\)</span> and <span class="math">\(r\)</span> based on a set of
<span class="math">\(m\)</span> simulations with corresponding pairs <span class="math">\((\Delta t_i, E_i)\)</span>, <span class="math">\(i=0,\ldots,m-1\)</span>,
and <span class="math">\(\Delta t_{i} &lt; \Delta t_{i-1}\)</span> (i.e., decreasing cell size).</p>
<blockquote>
<div><ol class="arabic simple">
<li>Take the logarithm of <a href="#equation-decay:E:dt">(3)</a>, <span class="math">\(\ln E = r\ln \Delta t + \ln C\)</span>,
and fit a straight line to the data points <span class="math">\((\Delta t_i, E_i)\)</span>,
<span class="math">\(i=0,\ldots,m-1\)</span>.</li>
<li>Consider two consecutive experiments, <span class="math">\((\Delta t_i, E_i)\)</span> and
<span class="math">\((\Delta t_{i-1}, E_{i-1})\)</span>. Dividing the equation
<span class="math">\(E_{i-1}=C\Delta t_{i-1}^r\)</span> by <span class="math">\(E_{i}=C\Delta t_{i}^r\)</span> and solving
for <span class="math">\(r\)</span> yields</li>
</ol>
</div></blockquote>
<div class="math" id="equation-decay:conv:rate">
<span class="eqno">(4)</span>\[     r_{i-1} = \frac{\ln (E_{i-1}/E_i)}{\ln (\Delta t_{i-1}/\Delta t_i)}\]</div>
<p>for <span class="math">\(i=1,\ldots,m-1\)</span>.</p>
<p>The disadvantage of method 1 is that <a href="#equation-decay:E:dt">(3)</a> might not be valid
for the coarsest meshes (largest <span class="math">\(\Delta t\)</span> values). Fitting a line
to all the data points is then misleading.  Method 2 computes
convergence rates for pairs of experiments and allows us to see
if the sequence <span class="math">\(r_i\)</span> converges to some value as <span class="math">\(i\rightarrow m-2\)</span>.
The final <span class="math">\(r_{m-2}\)</span> can then be taken as the convergence rate.
If the coarsest meshes have a differing rate, the corresponding
time steps are probably too large for <a href="#equation-decay:E:dt">(3)</a> to be valid.
That is, those time steps lie outside the asymptotic range of
<span class="math">\(\Delta t\)</span> values where the error behaves like <a href="#equation-decay:E:dt">(3)</a>.</p>
</div>
<div class="section" id="implementation-2">
<h4>Implementation  (2)<a class="headerlink" href="#implementation-2" title="Permalink to this headline">¶</a></h4>
<p>It is straightforward to extend the <tt class="docutils literal"><span class="pre">main</span></tt> function in the program
<tt class="docutils literal"><span class="pre">decay_argparse.py</span></tt> with statements for computing <span class="math">\(r_0, r_1, \ldots, r_{m-2}\)</span>
from <a href="#equation-decay:E:dt">(3)</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">,</span> <span class="n">dt_values</span> <span class="o">=</span> <span class="n">read_command_line</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># estimated convergence rates</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">E_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">E_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="c"># Compute convergence rates</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt_values</span><span class="p">)</span>
        <span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">log</span><span class="p">(</span><span class="n">E_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">E_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">dt_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">dt_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Pairwise convergence rates for theta=</span><span class="si">%g</span><span class="s">:&#39;</span> <span class="o">%</span> <span class="n">theta</span>
        <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">r_</span> <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">r</span>
</pre></div>
</div>
<p>The program containing this <tt class="docutils literal"><span class="pre">main</span></tt> function is called <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_convrate.py">decay_convrate.py</a>.</p>
<p id="index-11">The <tt class="docutils literal"><span class="pre">r</span></tt> object is a <em>dictionary of lists</em>. The keys in this
dictionary are the <span class="math">\(\theta\)</span> values. For example,
<tt class="docutils literal"><span class="pre">r[1]</span></tt> holds the list of the <span class="math">\(r_i\)</span> values corresponding to
<span class="math">\(\theta=1\)</span>. In the loop <tt class="docutils literal"><span class="pre">for</span> <span class="pre">theta</span> <span class="pre">in</span> <span class="pre">r</span></tt>, the loop variable <tt class="docutils literal"><span class="pre">theta</span></tt>
takes on the values of the keys in the dictionary <tt class="docutils literal"><span class="pre">r</span></tt> (in an
undetermined ordering). We could simply do a <tt class="docutils literal"><span class="pre">print</span> <span class="pre">r[theta]</span></tt>
inside the loop, but this would typically yield output of
the convergence rates with 16 decimals:</p>
<div class="highlight-text"><div class="highlight"><pre>[1.331919482274763, 1.1488178494691532, ...]
</pre></div>
</div>
<p>Instead, we format each number with 2 decimals, using a list
comprehension to turn the list of numbers, <tt class="docutils literal"><span class="pre">r[theta]</span></tt>, into
a list of formatted strings. Then we join these strings
with a space in between to get a sequence of rates on one line
in the terminal window. More generally, <tt class="docutils literal"><span class="pre">d.join(list)</span></tt> joins the
strings in the list <tt class="docutils literal"><span class="pre">list</span></tt> to one string, with <tt class="docutils literal"><span class="pre">d</span></tt>
as delimiter between <tt class="docutils literal"><span class="pre">list[0]</span></tt>, <tt class="docutils literal"><span class="pre">list[1]</span></tt>, etc.</p>
<p>Here is an example on the outcome of the convergence rate computations:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_convrate.py --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates for theta=0:
1.33 1.15 1.07 1.03 1.02

Pairwise convergence rates for theta=0.5:
2.14 2.07 2.03 2.01 2.01

Pairwise convergence rates for theta=1:
0.98 0.99 0.99 1.00 1.00
</pre></div>
</div>
<p>The Forward and Backward Euler methods seem to have an <span class="math">\(r\)</span> value which
stabilizes at 1, while the Crank-Nicolson seems to be a second-order
method with <span class="math">\(r=2\)</span>.</p>
<p id="index-12">Very often, we have some theory that predicts what <span class="math">\(r\)</span> is for a numerical
method. Various theoretical error measures for the <span class="math">\(\theta\)</span>-rule point to
<span class="math">\(r=2\)</span> for <span class="math">\(\theta =0.5\)</span> and <span class="math">\(r=1\)</span> otherwise. The computed estimates of <span class="math">\(r\)</span> are
in very good agreement with these theoretical values.</p>
<div class="admonition-why-convergence-rates-are-important admonition">
<p class="first admonition-title">Why convergence rates are important</p>
<p class="last">The strong practical application of computing convergence rates is for
verification: wrong convergence rates point to errors in the code, and
correct convergence rates brings evidence that the implementation is
correct. Experience shows that bugs in the code easily destroy the
expected convergence rate.</p>
</div>
</div>
<div class="section" id="debugging-via-convergence-rates">
<h4>Debugging via convergence rates<a class="headerlink" href="#debugging-via-convergence-rates" title="Permalink to this headline">¶</a></h4>
<p>Let us experiment with bugs and see the implication on the convergence
rate. We may, for instance, forget to multiply by <tt class="docutils literal"><span class="pre">a</span></tt> in the denominator
in the updating formula for <tt class="docutils literal"><span class="pre">u[n+1]</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
<p>Running the same <tt class="docutils literal"><span class="pre">decay_convrate.py</span></tt> command as above gives the expected
convergence rates (!). Why? The reason is that we just specified
the <span class="math">\(\Delta t\)</span> values are relied on default values for other
parameters. The default value of <span class="math">\(a\)</span> is 1. Forgetting the factor
<tt class="docutils literal"><span class="pre">a</span></tt> has then no effect. This example shows how important it is to
avoid parameters that are 1 or 0 when verifying implementations.
Running the code <tt class="docutils literal"><span class="pre">decay_v0.py</span></tt> with <span class="math">\(a=2.1\)</span> and <span class="math">\(I=0.1\)</span> yields</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_convrate.py --a 2.1 --I 0.1  \
          --dt 0.5 0.25 0.1 0.05 0.025 0.01
...
Pairwise convergence rates for theta=0:
1.49 1.18 1.07 1.04 1.02

Pairwise convergence rates for theta=0.5:
-1.42 -0.22 -0.07 -0.03 -0.01

Pairwise convergence rates for theta=1:
0.21 0.12 0.06 0.03 0.01
</pre></div>
</div>
<p>This time we see that the expected convergence rates for the Crank-Nicolson and
Backward Euler methods are not obtained, while <span class="math">\(r=1\)</span> for the Forward Euler
method. The reason for correct rate in the latter case is that <span class="math">\(\theta=0\)</span>
and the wrong <tt class="docutils literal"><span class="pre">theta*dt</span></tt> term in the denominator vanishes anyway.</p>
<p>The error</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
<p>manifests itself through wrong rates <span class="math">\(r\approx 0\)</span> for all three methods.
About the same results arise from an erroneous initial condition, <tt class="docutils literal"><span class="pre">u[0]</span> <span class="pre">=</span> <span class="pre">1</span></tt>,
or wrong loop limits, <tt class="docutils literal"><span class="pre">range(1,Nt)</span></tt>. It seems that in this simple
problem, most bugs we can think of are detected by the convergence rate
test, provided the values of the input data do not hide the bug.</p>
<p>A <tt class="docutils literal"><span class="pre">verify_convergence_rate</span></tt> function could compute the dictionary of
list via <tt class="docutils literal"><span class="pre">main</span></tt> and check if the final rate estimates (<span class="math">\(r_{m-2}\)</span>)
are sufficiently close to the expected ones. A tolerance of 0.1
seems appropriate, given the uncertainty in estimating <span class="math">\(r\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">verify_convergence_rate</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">expected_rates</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">r_final</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected_rates</span><span class="p">[</span><span class="n">theta</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_final</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>  <span class="c"># all tests passed</span>
</pre></div>
</div>
<p>We remark that <tt class="docutils literal"><span class="pre">r[theta]</span></tt> is a list and the last element in any list
can be extracted by the index <tt class="docutils literal"><span class="pre">-1</span></tt>.</p>
</div>
</div>
</div>
<div class="section" id="software-engineering">
<h2>Software engineering<a class="headerlink" href="#software-engineering" title="Permalink to this headline">¶</a></h2>
<div class="admonition-goal admonition">
<p class="first admonition-title">Goal</p>
<p>Efficient use of differential equation models requires software that is easy to
test and flexible for setting up extensive numerical experiments.
This section introduces three important concepts:</p>
<blockquote>
<div><ul class="simple">
<li>Modules</li>
<li>Testing frameworks</li>
<li>Implementation with classes</li>
</ul>
</div></blockquote>
<p class="last">The concepts are introduced using the differential equation
problem <span class="math">\(u'=-au\)</span>, <span class="math">\(u(0)=I\)</span>, as example.</p>
</div>
<div class="section" id="making-a-module">
<span id="decay-prog-se-module"></span><h3>Making a module<a class="headerlink" href="#making-a-module" title="Permalink to this headline">¶</a></h3>
<div class="admonition-the-dry-principle admonition" id="index-13">
<p class="first admonition-title">The DRY principle</p>
<p class="last">The previous sections have outlined numerous different programs, all of
them having their own copy of the <tt class="docutils literal"><span class="pre">solver</span></tt> function.  Such copies
of the same piece of code is against the important <em>Don&#8217;t Repeat
Yourself</em> (DRY) principle in programming.  If we want to change the
<tt class="docutils literal"><span class="pre">solver</span></tt> function there should be <em>one and only one</em> place where the
change needs to be performed.</p>
</div>
<p>To clean up the repetitive code snippets scattered among the
<tt class="docutils literal"><span class="pre">decay_*.py</span></tt> files, we start by collecting the
various functions we want to keep for the future in one file,
now called <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_mod.py">decay_mod.py</a> (<tt class="docutils literal"><span class="pre">mod</span></tt> stands for &#8220;module&#8221;).
The following functions are copied to this file:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">solver</span></tt> for computing the numerical solution</li>
<li><tt class="docutils literal"><span class="pre">verify_three_steps</span></tt> for verifying the first three solution
points against hand calculations</li>
<li><tt class="docutils literal"><span class="pre">verify_discrete_solution</span></tt> for verifying the entire computed solution
against an exact formula for the numerical solution</li>
<li><tt class="docutils literal"><span class="pre">explore</span></tt> for computing and plotting the solution</li>
<li><tt class="docutils literal"><span class="pre">define_command_line_options</span></tt> for defining option-value pairs
on the command line</li>
<li><tt class="docutils literal"><span class="pre">read_command_line</span></tt> for reading input from the command line,
now extended to work both with <tt class="docutils literal"><span class="pre">sys.argv</span></tt> directly
and with an <tt class="docutils literal"><span class="pre">ArgumentParser</span></tt> object</li>
<li><tt class="docutils literal"><span class="pre">main</span></tt> for running experiments with <span class="math">\(\theta=0,0.5,1\)</span> and a series of
<span class="math">\(\Delta t\)</span> values, and computing convergence rates</li>
<li><tt class="docutils literal"><span class="pre">main_GUI</span></tt> for doing the same as the <tt class="docutils literal"><span class="pre">main</span></tt> function, but modified
for automatic GUI generation</li>
<li><tt class="docutils literal"><span class="pre">verify_convergence_rate</span></tt> for verifying the computed convergence
rates against the theoretically expected values</li>
</ul>
</div></blockquote>
<p>We use Matplotlib for plotting. A sketch of the <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt>
file, with complete versions of the modified functions, looks as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">verify_three_steps</span><span class="p">():</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">verify_exact_discrete_solution</span><span class="p">():</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">define_command_line_options</span><span class="p">():</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">read_command_line</span><span class="p">(</span><span class="n">use_argparse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">use_argparse</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">define_command_line_options</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;I={}, a={}, makeplot={}, dt_values={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">makeplot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dt_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">makeplot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dt_values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Usage: </span><span class="si">%s</span><span class="s"> I a on/off dt1 dt2 dt3 ...&#39;</span> <span class="o">%</span> \
                  <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">I</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">T</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">makeplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;True&#39;</span><span class="p">)</span>
        <span class="n">dt_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">:]]</span>

        <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">makeplot</span><span class="p">,</span> <span class="n">dt_values</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt> file is already a module such that we can import
desired functions in other programs. For example, we can in a file do</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">decay_mod</span> <span class="kn">import</span> <span class="n">solver</span>
<span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-14">However, it should also be possible to both use <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt> as
a module <em>and</em> execute the file as a program that runs <tt class="docutils literal"><span class="pre">main()</span></tt>. This is
accomplished by ending the file with a <em>test block</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>When <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt> is used as a module, <tt class="docutils literal"><span class="pre">__name__</span></tt> equals the module
name <tt class="docutils literal"><span class="pre">decay_mod</span></tt>, while <tt class="docutils literal"><span class="pre">__name__</span></tt> equals <tt class="docutils literal"><span class="pre">'__main__'</span></tt> when the
file is run as a program.
Optionally, we could run the verification tests if the word <tt class="docutils literal"><span class="pre">verify</span></tt>
is present on the command line and <tt class="docutils literal"><span class="pre">verify_convergence_rate</span></tt> could
be tested if <tt class="docutils literal"><span class="pre">verify_rates</span></tt> is found on the command line. The
<tt class="docutils literal"><span class="pre">verify_rates</span></tt> argument must be removed before we read parameter values from
the command line, otherwise the <tt class="docutils literal"><span class="pre">read_command_line</span></tt> function (called by <tt class="docutils literal"><span class="pre">main</span></tt>)
will not work properly.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">&#39;verify&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verify_three_steps</span><span class="p">()</span> <span class="ow">and</span> <span class="n">verify_discrete_solution</span><span class="p">():</span>
            <span class="k">pass</span> <span class="c"># ok</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Bug in the implementation!&#39;</span>
    <span class="k">elif</span> <span class="s">&#39;verify_rates&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;verify_rates&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;--dt&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Must assign several dt values&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># abort</span>
        <span class="k">if</span> <span class="n">verify_convergence_rate</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Bug in the implementation!&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Perform simulations</span>
        <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="prefixing-imported-functions-by-the-module-name">
<span id="decay-prog-se-import"></span><h3>Prefixing imported functions by the module name<a class="headerlink" href="#prefixing-imported-functions-by-the-module-name" title="Permalink to this headline">¶</a></h3>
<p id="index-15">Import statements of the form <tt class="docutils literal"><span class="pre">from</span> <span class="pre">module</span> <span class="pre">import</span> <span class="pre">*</span></tt> import
functions and variables in <tt class="docutils literal"><span class="pre">module.py</span></tt> into the current file.
For example, when doing</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>we get mathematical functions like <tt class="docutils literal"><span class="pre">sin</span></tt> and <tt class="docutils literal"><span class="pre">exp</span></tt>
as well as MATLAB-style functions like <tt class="docutils literal"><span class="pre">linspace</span></tt> and <tt class="docutils literal"><span class="pre">plot</span></tt>,
which can be called by these well-known names.
Unfortunately, it sometimes becomes confusing to
know where a particular function comes from. Is it from <tt class="docutils literal"><span class="pre">numpy</span></tt>? Or
<tt class="docutils literal"><span class="pre">matplotlib.pyplot</span></tt>?
Or is it our own function?</p>
<p>An alternative import is</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>
</pre></div>
</div>
<p>and such imports require functions to be prefixed by the module name, e.g.,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">u_e</span> <span class="o">=</span> <span class="n">I</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u_e</span><span class="p">)</span>
</pre></div>
</div>
<p>This is normally regarded as a better habit because it is explicitly stated
from which module a function comes from.</p>
<p>The modules <tt class="docutils literal"><span class="pre">numpy</span></tt> and <tt class="docutils literal"><span class="pre">matplotlib.pyplot</span></tt> are so frequently used,
and their full names quite tedious to write, so two standard abbreviations
have evolved in the Python scientific computing community:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">u_e</span> <span class="o">=</span> <span class="n">I</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u_e</span><span class="p">)</span>
</pre></div>
</div>
<p>A version of the <tt class="docutils literal"><span class="pre">decay_mod</span></tt> module where we use the <tt class="docutils literal"><span class="pre">np</span></tt> and <tt class="docutils literal"><span class="pre">plt</span></tt>
prefixes is found in the file
<a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_mod_prefix.py">decay_mod_prefix.py</a>.</p>
<p>The downside of prefixing functions by the module name is that
mathematical expressions like <span class="math">\(e^{-at}\sin(2\pi t)\)</span> get
cluttered with module names,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="c"># or</span>
<span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>Such an expression looks like <tt class="docutils literal"><span class="pre">exp(-a*t)*sin(2*pi*t)</span></tt> in most
other programming languages. Similarly,
<tt class="docutils literal"><span class="pre">np.linspace</span></tt> and <tt class="docutils literal"><span class="pre">plt.plot</span></tt> look less familiar to people who are
used to MATLAB and who have not adopted Python&#8217;s prefix style.
Whether to do <tt class="docutils literal"><span class="pre">from</span> <span class="pre">module</span> <span class="pre">import</span> <span class="pre">*</span></tt> or <tt class="docutils literal"><span class="pre">import</span> <span class="pre">module</span></tt> depends
on personal taste and the problem at hand. In these writings we use
<tt class="docutils literal"><span class="pre">from</span> <span class="pre">module</span> <span class="pre">import</span></tt> in shorter programs where similarity with
MATLAB could be an advantage, and where a one-to-one correspondence between
mathematical formulas and Python expressions is important.
The style <tt class="docutils literal"><span class="pre">import</span> <span class="pre">module</span></tt> is preferred inside Python modules (see
<a class="reference internal" href="#decay-exer-module1"><em>Problem 5: Make a module</em></a> for a demonstration).</p>
</div>
<div class="section" id="doctests">
<span id="decay-prog-se-doctest"></span><h3>Doctests<a class="headerlink" href="#doctests" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-16"></span><p id="index-17">We have emphasized how important it is to be able to run tests in the
program at any time. This was solved by calling various <tt class="docutils literal"><span class="pre">verify*</span></tt>
functions in the previous examples. However, there exists
well-established procedures and corresponding tools for automating
the execution of tests. We shall briefly demonstrate two important
techniques: <em>doctest</em> and <em>unit testing</em>. The corresponding files are
the modules <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_mod_doctest.py">decay_mod_doctest.py</a>
and <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_mod_nosetest.py">decay_mod_nosetest.py</a>.</p>
<p>A doc string (the first string after the function header) is used to
document the purpose of functions and their arguments. Very often it
is instructive to include an example on how to use the function.
Interactive examples in the Python shell are most illustrative as
we can see the output resulting from function calls. For example,
we can in the <tt class="docutils literal"><span class="pre">solver</span></tt> function include an example on calling
this function and printing the computed <tt class="docutils literal"><span class="pre">u</span></tt> and <tt class="docutils literal"><span class="pre">t</span></tt> arrays:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve u&#39;=-a*u, u(0)=I, for t in (0,T] with steps of dt.</span>


<span class="sd">    &gt;&gt;&gt; u, t = solver(I=0.8, a=1.2, T=4, dt=0.5, theta=0.5)</span>
<span class="sd">    &gt;&gt;&gt; for t_n, u_n in zip(t, u):</span>
<span class="sd">    ...     print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)</span>
<span class="sd">    t=0.0, u=0.80000000000000</span>
<span class="sd">    t=0.5, u=0.43076923076923</span>
<span class="sd">    t=1.0, u=0.23195266272189</span>
<span class="sd">    t=1.5, u=0.12489758761948</span>
<span class="sd">    t=2.0, u=0.06725254717972</span>
<span class="sd">    t=2.5, u=0.03621291001985</span>
<span class="sd">    t=3.0, u=0.01949925924146</span>
<span class="sd">    t=3.5, u=0.01049960113002</span>
<span class="sd">    t=4.0, u=0.00565363137770</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>When such interactive demonstrations are inserted in doc strings,
Python&#8217;s <a class="reference external" href="http://docs.python.org/library/doctest.html">doctest</a>
module can be used to automate running all commands
in interactive sessions and compare new output with the output
appearing in the doc string.  All we have to do in the current example
is to write</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Terminal</span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">doctest</span> <span class="n">decay_mod_doctest</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This command imports the <tt class="docutils literal"><span class="pre">doctest</span></tt> module, which runs all tests.
No additional command-line argument is allowed when running doctests.
If any test fails, the problem is reported, e.g.,</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python -m doctest decay_mod_doctest.py
********************************************************
File &quot;decay_mod_doctest.py&quot;, line 12, in decay_mod_doctest....
Failed example:
    for t_n, u_n in zip(t, u):
        print &#39;t=%.1f, u=%.14f&#39; % (t_n, u_n)
Expected:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761948
    t=2.0, u=0.06725254717972
Got:
    t=0.0, u=0.80000000000000
    t=0.5, u=0.43076923076923
    t=1.0, u=0.23195266272189
    t=1.5, u=0.12489758761948
    t=2.0, u=0.06725254718756
********************************************************
1 items had failures:
   1 of   2 in decay_mod_doctest.solver
***Test Failed*** 1 failures.
</pre></div>
</div>
<p>Note that in the output of <tt class="docutils literal"><span class="pre">t</span></tt> and <tt class="docutils literal"><span class="pre">u</span></tt> we write <tt class="docutils literal"><span class="pre">u</span></tt> with 14 digits.
Writing all 16 digits is not a good idea: if the tests are run on
different hardware, round-off errors might be different, and
the <tt class="docutils literal"><span class="pre">doctest</span></tt> module detects that the numbers are not precisely the same
and reports failures. In the present application, where <span class="math">\(0 &lt; u(t) \leq 0.8\)</span>,
we expect round-off errors to be of size <span class="math">\(10^{-16}\)</span>, so comparing 15
digits would probably be reliable, but we compare 14 to be on the
safe side.</p>
<p>Doctests are highly encouraged as they do two things: 1) demonstrate
how a function is used and 2) test that the function works.</p>
<p>Here is an example on a doctest in the <tt class="docutils literal"><span class="pre">explore</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">explore</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">makeplot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a case with the solver, compute error measure,</span>
<span class="sd">    and plot the numerical and exact solutions (if makeplot=True).</span>

<span class="sd">    &gt;&gt;&gt; for theta in 0, 0.5, 1:</span>
<span class="sd">    ...    E = explore(I=1.9, a=2.1, T=5, dt=0.1, theta=theta,</span>
<span class="sd">    ...                makeplot=False)</span>
<span class="sd">    ...    print &#39;%.10E&#39; % E</span>
<span class="sd">    ...</span>
<span class="sd">    7.3565079236E-02</span>
<span class="sd">    2.4183893110E-03</span>
<span class="sd">    6.5013039886E-02</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This time we limit the output to 10 digits.</p>
<div class="admonition-caution admonition">
<p class="first admonition-title">Caution</p>
<p class="last">Doctests requires careful coding if they use command-line input or
print results to the terminal window. Command-line input must
be simulated by filling <tt class="docutils literal"><span class="pre">sys.argv</span></tt> correctly, e.g.,
<tt class="docutils literal"><span class="pre">sys.argv</span> <span class="pre">=</span> <span class="pre">'--I</span> <span class="pre">1.0</span> <span class="pre">--a</span> <span class="pre">5'.split</span></tt>.
The output lines of print statements must be copied exactly as they
appear when running the statements in an interactive Python shell.</p>
</div>
</div>
<div class="section" id="unit-testing-with-nose">
<span id="decay-prog-se-nose"></span><h3>Unit testing with nose<a class="headerlink" href="#unit-testing-with-nose" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-18"></span><span class="target" id="index-19"></span><p id="index-20">The unit testing technique consists of identifying small units
of code, usually functions (or classes), and write one or more tests for
each unit. One test should, ideally, not depend on the outcome of
other tests. For example, the doctest in function <tt class="docutils literal"><span class="pre">solver</span></tt> is a
unit test, and the doctest in function <tt class="docutils literal"><span class="pre">explore</span></tt> as well, but the
latter depends on a working <tt class="docutils literal"><span class="pre">solver</span></tt>. Putting the error computation
and plotting in <tt class="docutils literal"><span class="pre">explore</span></tt> in two separate functions would allow
independent unit tests. In this way, the design of unit tests impacts
the design of functions. The recommended practice is actually to
design and write the unit tests first and <em>then</em> implement the functions!</p>
<p>In scientific computing it is not always obvious how to best perform
unit testing. The units is naturally larger than in non-scientific
software. Very often the solution procedure of a mathematical problem
identifies a unit.</p>
<div class="section" id="basic-use-of-nose">
<h4>Basic use of nose<a class="headerlink" href="#basic-use-of-nose" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">nose</span></tt> package is a versatile tool for implementing unit tests
in Python. Here is a short explanation of the usage of nose:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Implement tests in functions with names starting with <tt class="docutils literal"><span class="pre">test_</span></tt>.
Such functions cannot have any arguments.</li>
<li>The test functions perform assertions on computed results
using <tt class="docutils literal"><span class="pre">assert</span></tt> functions from the <tt class="docutils literal"><span class="pre">nose.tools</span></tt> module.</li>
<li>The test functions can be in the source code files or be
collected in separate files with names <tt class="docutils literal"><span class="pre">test*.py</span></tt>.</li>
</ol>
</div></blockquote>
<p>Here comes a very simple illustration of the three points.
Assume that we have this function in a module <tt class="docutils literal"><span class="pre">mymod</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span>
</pre></div>
</div>
<p>Either in this file, or in a separate file <tt class="docutils literal"><span class="pre">test_mymod.py</span></tt>, we
implement a test function whose purpose is
to test that the function <tt class="docutils literal"><span class="pre">double</span></tt> works as intended:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nose.tools</span> <span class="kn">as</span> <span class="nn">nt</span>

<span class="k">def</span> <span class="nf">test_double</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that <tt class="docutils literal"><span class="pre">test_double</span></tt> has no arguments.
We need to do an <tt class="docutils literal"><span class="pre">import</span> <span class="pre">mymod</span></tt> or <tt class="docutils literal"><span class="pre">from</span> <span class="pre">mymod</span> <span class="pre">import</span> <span class="pre">double</span></tt>
if this test resides in a separate file.
Running</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; nosetests -s mymod
</pre></div>
</div>
<p>makes the <tt class="docutils literal"><span class="pre">nose</span></tt> tool run all functions with names matching <tt class="docutils literal"><span class="pre">test_*()</span></tt>
in <tt class="docutils literal"><span class="pre">mymod.py</span></tt>.
Alternatively, if the test functions are in some <tt class="docutils literal"><span class="pre">test_mymod.py</span></tt> file,
we can just write <tt class="docutils literal"><span class="pre">nosetests</span> <span class="pre">-s</span></tt>. The nose tool will then look
for all files with names mathching <tt class="docutils literal"><span class="pre">test*.py</span></tt> and run all
functions <tt class="docutils literal"><span class="pre">test_*()</span></tt> in these files.</p>
<p>When you have nose tests in separate test
files with names <tt class="docutils literal"><span class="pre">test*.py</span></tt> it is common to collect
these files in a subdirectory <tt class="docutils literal"><span class="pre">tests</span></tt>, or <tt class="docutils literal"><span class="pre">*_tests</span></tt> if
you have several test subdirectories. Running <tt class="docutils literal"><span class="pre">nosetests</span> <span class="pre">-s</span></tt> will
then recursively look for all <tt class="docutils literal"><span class="pre">tests</span></tt> and <tt class="docutils literal"><span class="pre">*_tests</span></tt> subdirectories
and run all functions <tt class="docutils literal"><span class="pre">test_*()</span></tt> in all files <tt class="docutils literal"><span class="pre">test_*.py</span></tt> in these
directories. Just one command can then launch a series of tests in
a directory tree!</p>
<p>An example of a <tt class="docutils literal"><span class="pre">tests</span></tt> directory with different types of <tt class="docutils literal"><span class="pre">test*.py</span></tt>
files are found in <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/tests">src/decay/tests</a>.
Note that these perform imports of modules in the parent directory.
These imports works well because the tests are supposed to be
run by <tt class="docutils literal"><span class="pre">nosetests</span> <span class="pre">-s</span></tt> executed in the parent directory (<tt class="docutils literal"><span class="pre">decay</span></tt>).</p>
<div class="admonition-tip admonition">
<p class="first admonition-title">Tip</p>
<p class="last">The <tt class="docutils literal"><span class="pre">-s</span></tt> option to <tt class="docutils literal"><span class="pre">nosetests</span></tt> assures that any print statement
in the <tt class="docutils literal"><span class="pre">test_*</span></tt> functions appears in the output. Without this
option, <tt class="docutils literal"><span class="pre">nosetests</span></tt> suppressed whatever the tests writes to
the terminal window (standard output). Such behavior is annoying,
especially when developing and testing tests.</p>
</div>
<p>The number of failed tests and their details are
reported, or an <tt class="docutils literal"><span class="pre">OK</span></tt> is printed if all tests passed.</p>
<p>The advantage with the <tt class="docutils literal"><span class="pre">nose</span></tt> package is two-fold:</p>
<ol class="arabic simple">
<li>tests are written and collected
in a structured way, and</li>
<li>large collections of tests, scattered
throughout a tree of directories,
can be executed with one command <tt class="docutils literal"><span class="pre">nosetests</span> <span class="pre">-s</span></tt>.</li>
</ol>
</div>
<div class="section" id="alternative-assert-statements">
<h4>Alternative assert statements<a class="headerlink" href="#alternative-assert-statements" title="Permalink to this headline">¶</a></h4>
<p>In case the <tt class="docutils literal"><span class="pre">nt.assert_equal</span></tt> function
finds that the two arguments are equal, the test is a success, otherwise
it is a failure and an exception of type <tt class="docutils literal"><span class="pre">AssertionError</span></tt> is raised.
The particular exception is the indicator that a test has failed.</p>
<p>Instead of calling the convenience function <tt class="docutils literal"><span class="pre">nt.assert_equal</span></tt>, we
can use Python&#8217;s plain <tt class="docutils literal"><span class="pre">assert</span></tt> statement, which tests if a boolean
expression is true and raises an <tt class="docutils literal"><span class="pre">AssertionError</span></tt> otherwise.
Here, the statement is <tt class="docutils literal"><span class="pre">assert</span> <span class="pre">result</span> <span class="pre">==</span> <span class="pre">8</span></tt>.</p>
<p>A completely manual alternative is to explicitly raise an <tt class="docutils literal"><span class="pre">AssertionError</span></tt>
exception if the computed result is wrong:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="applying-nose">
<h4>Applying nose<a class="headerlink" href="#applying-nose" title="Permalink to this headline">¶</a></h4>
<p>Let us illustrate how to use the <tt class="docutils literal"><span class="pre">nose</span></tt> tool for testing key functions
in the <tt class="docutils literal"><span class="pre">decay_mod</span></tt> module. Or more precisely, the module is called
<tt class="docutils literal"><span class="pre">decay_mod_unittest</span></tt> with all the <tt class="docutils literal"><span class="pre">verify*</span></tt> functions removed
as these now are outdated by the unit tests.</p>
<p>We design three unit tests:</p>
<blockquote>
<div><ol class="arabic simple">
<li>A comparison between the computed <span class="math">\(u^n\)</span> values and the
exact discrete solution.</li>
<li>A comparison between the computed <span class="math">\(u^n\)</span> values and precomputed,
verified reference values.</li>
<li>A comparison between observed and expected convergence rates.</li>
</ol>
</div></blockquote>
<p>These tests follow very closely the code in the previously shown
<tt class="docutils literal"><span class="pre">verify*</span></tt> functions. We start with comparing <span class="math">\(u^n\)</span>, as computed by
the function <tt class="docutils literal"><span class="pre">solver</span></tt>, to the formula
for the exact discrete solution:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nose.tools</span> <span class="kn">as</span> <span class="nn">nt</span>
<span class="kn">import</span> <span class="nn">decay_mod_unittest</span> <span class="kn">as</span> <span class="nn">decay_mod</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return exact discrete solution of the theta scheme.&quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>  <span class="c"># avoid integer division</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">factor</span><span class="o">**</span><span class="n">n</span>

<span class="k">def</span> <span class="nf">test_exact_discrete_solution</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare result from solver against</span>
<span class="sd">    formula for the discrete solution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>  <span class="c"># no of steps</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">decay_mod</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">u_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1E-14</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">nt.assert_almost_equal</span></tt> is the relevant function for comparing two
real numbers. The <tt class="docutils literal"><span class="pre">delta</span></tt> argument specifies a tolerance for the
comparison. Alternatively, one can specify a <tt class="docutils literal"><span class="pre">places</span></tt> argument
for the number of decimal places to be used in the comparison.</p>
<p>After having carefully verified the implementation, we may
store correctly computed numbers in the test program or in files for
use in future tests. Here is an example on how the outcome from the
<tt class="docutils literal"><span class="pre">solver</span></tt> function can be compared to what is considered to be
correct results:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_solver</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare result from solver against</span>
<span class="sd">    precomputed arrays for theta=0, 0.5, 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">I</span><span class="o">=</span><span class="mf">0.8</span><span class="p">;</span> <span class="n">a</span><span class="o">=</span><span class="mf">1.2</span><span class="p">;</span> <span class="n">T</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span>  <span class="c"># fixed parameters</span>
    <span class="n">precomputed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.</span> <span class="p">,</span>  <span class="mf">0.5</span><span class="p">,</span>  <span class="mf">1.</span> <span class="p">,</span>  <span class="mf">1.5</span><span class="p">,</span>  <span class="mf">2.</span> <span class="p">,</span>  <span class="mf">2.5</span><span class="p">,</span>
                        <span class="mf">3.</span> <span class="p">,</span>  <span class="mf">3.5</span><span class="p">,</span>  <span class="mf">4.</span> <span class="p">]),</span>
        <span class="mf">0.5</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span> <span class="mf">0.8</span>       <span class="p">,</span>  <span class="mf">0.43076923</span><span class="p">,</span>  <span class="mf">0.23195266</span><span class="p">,</span> <span class="mf">0.12489759</span><span class="p">,</span>
              <span class="mf">0.06725255</span><span class="p">,</span>  <span class="mf">0.03621291</span><span class="p">,</span>  <span class="mf">0.01949926</span><span class="p">,</span> <span class="mf">0.0104996</span> <span class="p">,</span>
              <span class="mf">0.00565363</span><span class="p">]),</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>  <span class="mf">8.00000000e-01</span><span class="p">,</span>   <span class="mf">3.20000000e-01</span><span class="p">,</span>
               <span class="mf">1.28000000e-01</span><span class="p">,</span>   <span class="mf">5.12000000e-02</span><span class="p">,</span>
               <span class="mf">2.04800000e-02</span><span class="p">,</span>   <span class="mf">8.19200000e-03</span><span class="p">,</span>
               <span class="mf">3.27680000e-03</span><span class="p">,</span>   <span class="mf">1.31072000e-03</span><span class="p">,</span>
               <span class="mf">5.24288000e-04</span><span class="p">]),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span> <span class="mf">0.8</span>       <span class="p">,</span>  <span class="mf">0.5</span>       <span class="p">,</span>  <span class="mf">0.3125</span>    <span class="p">,</span>  <span class="mf">0.1953125</span> <span class="p">,</span>
              <span class="mf">0.12207031</span><span class="p">,</span>  <span class="mf">0.07629395</span><span class="p">,</span>  <span class="mf">0.04768372</span><span class="p">,</span>  <span class="mf">0.02980232</span><span class="p">,</span>
              <span class="mf">0.01862645</span><span class="p">]),</span>
        <span class="p">}</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">decay_mod</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">precomputed</span><span class="p">[</span><span class="n">theta</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c"># Precomputed numbers are known to 8 decimal places</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                               <span class="n">msg</span><span class="o">=</span><span class="s">&#39;theta=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">theta</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">precomputed</span></tt> object is a dictionary with four keys: <tt class="docutils literal"><span class="pre">'t'</span></tt> for the
time mesh, and three <span class="math">\(\theta\)</span> values for <span class="math">\(u^n\)</span> solutions corresponding
to <span class="math">\(\theta=0,0.5,1\)</span>.</p>
<p>Testing for special type of input data that may cause trouble constitutes
a common way of constructing unit tests.
For example, the updating formula for
<span class="math">\(u^{n+1}\)</span> may be incorrectly evaluated because of unintended integer
divisions. With</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">theta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
<p>the nominator and denominator in the updating expression,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>evaluate to 1 and 3, respectively, and the fraction <tt class="docutils literal"><span class="pre">1/3</span></tt> will
call up integer division and consequently lead to <tt class="docutils literal"><span class="pre">u[n+1]=0</span></tt>.
We construct a unit test to make sure <tt class="docutils literal"><span class="pre">solver</span></tt> is smart
enough to avoid this problem:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_potential_integer_division</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Choose variables that can trigger integer division.&quot;&quot;&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dt</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">decay_mod</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">u_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1E-14</span><span class="p">)</span>
</pre></div>
</div>
<p>The final test is to see that the convergence rates corresponding to
<span class="math">\(\theta=0,0.5, 1\)</span> are 1, 2, and 1, respectively:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_convergence_rates</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Compare empirical convergence rates to exact ones.&quot;&quot;&quot;</span>
    <span class="c"># Set command-line arguments directly in sys.argv</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="s">&#39;--I 0.8 --a 2.1 --T 5 &#39;</span>\
                   <span class="s">&#39;--dt 0.4 0.2 0.1 0.05 0.025&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">decay_mod</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">assert_true</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">])</span>  <span class="c"># check for non-empty list</span>

    <span class="n">expected_rates</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">r_final</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">theta</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Compare to 1 decimal place</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">expected_rates</span><span class="p">[</span><span class="n">theta</span><span class="p">],</span> <span class="n">r_final</span><span class="p">,</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;theta=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">theta</span><span class="p">)</span>
</pre></div>
</div>
<p>Nothing more is needed in the <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/tests/test_decay_nose.py">test_decay_nose.py</a>
file where the tests reside.
Running <tt class="docutils literal"><span class="pre">nosetests</span> <span class="pre">-s</span></tt> will report <tt class="docutils literal"><span class="pre">Ran</span> <span class="pre">3</span> <span class="pre">tests</span></tt> and an <tt class="docutils literal"><span class="pre">OK</span></tt> for
success.  Every time we modify the <tt class="docutils literal"><span class="pre">decay_mod_unittest</span></tt> module we can
run <tt class="docutils literal"><span class="pre">nosetests</span></tt> to quickly see if the edits have any impact on the
verification tests.</p>
</div>
<div class="section" id="installation-of-nose">
<h4>Installation of nose<a class="headerlink" href="#installation-of-nose" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">nose</span></tt> package does not come with a standard Python distribution and must
therefore be installed separately. The procedure is standard and
described on <a class="reference external" href="http://nose.readthedocs.org/en/latest/">Nose&#8217;s web pages</a>.  On Debian-based Linux
systems the command is <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">python-nose</span></tt>, and
with MacPorts you run <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">port</span> <span class="pre">install</span> <span class="pre">py27-nose</span></tt>.</p>
<span class="target" id="index-21"></span></div>
<div class="section" id="using-nose-to-test-modules-with-doctests">
<span id="index-22"></span><h4>Using nose to test modules with doctests<a class="headerlink" href="#using-nose-to-test-modules-with-doctests" title="Permalink to this headline">¶</a></h4>
<p>Assume that <tt class="docutils literal"><span class="pre">mod</span></tt> is the name of some module that contains doctests.
We may let <tt class="docutils literal"><span class="pre">nose</span></tt> run these doctests and report errors in the
standard way using the code set-up</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">mod</span>

<span class="k">def</span> <span class="nf">test_mod</span><span class="p">():</span>
    <span class="n">failure_count</span><span class="p">,</span> <span class="n">test_count</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">mod</span><span class="p">)</span>
    <span class="n">nt</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">failure_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> tests out of </span><span class="si">%d</span><span class="s"> failed&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">failure_count</span><span class="p">,</span> <span class="n">test_count</span><span class="p">))</span>
</pre></div>
</div>
<p>The call to <tt class="docutils literal"><span class="pre">doctest.testmod</span></tt> runs all doctests in the module file
<tt class="docutils literal"><span class="pre">mod.py</span></tt> and returns the number of failures (<tt class="docutils literal"><span class="pre">failure_count</span></tt>)
and the total number of tests (<tt class="docutils literal"><span class="pre">test_count</span></tt>). A real example is
found in the file
<a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/tests/test_decay_doctest.py">test_decay_doctest.py</a>.</p>
</div>
</div>
<div class="section" id="classical-class-based-unit-testing">
<span id="decay-prog-se-unittest"></span><h3>Classical class-based unit testing<a class="headerlink" href="#classical-class-based-unit-testing" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-23"></span><span class="target" id="index-24"></span><p id="index-25">The classical way of implementing unit tests derives from the JUnit
tool in Java where all tests are methods in a class for testing.
Python comes with a module <tt class="docutils literal"><span class="pre">unittest</span></tt> for doing this type of unit tests.
While <tt class="docutils literal"><span class="pre">nose</span></tt> allows simple functions for unit tests, <tt class="docutils literal"><span class="pre">unittest</span></tt>
requires deriving a class <tt class="docutils literal"><span class="pre">Test*</span></tt> from <tt class="docutils literal"><span class="pre">unittest.TestCase</span></tt> and
implementing each test as methods with names <tt class="docutils literal"><span class="pre">test_*</span></tt> in that class.
I strongly recommend to use <tt class="docutils literal"><span class="pre">nose</span></tt> over <tt class="docutils literal"><span class="pre">unittest</span></tt>, because it is
much simpler and more convenient, but class-based unit testing
is a very classical subject that computational scientists should
have some knowledge about. That is why a short introduction
to <tt class="docutils literal"><span class="pre">unittest</span></tt> is included below.</p>
<div class="section" id="basic-use-of-unittest">
<h4>Basic use of unittest<a class="headerlink" href="#basic-use-of-unittest" title="Permalink to this headline">¶</a></h4>
<span class="target" id="index-26"></span><p id="index-27">We apply the <tt class="docutils literal"><span class="pre">double</span></tt> function in the <tt class="docutils literal"><span class="pre">mymod</span></tt> module introduced in the
previous section as example.
Unit testing with the aid of the <tt class="docutils literal"><span class="pre">unittest</span></tt> module
consists of writing a file <tt class="docutils literal"><span class="pre">test_mymod.py</span></tt> with the content</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">mymod</span>

<span class="k">class</span> <span class="nc">TestMyCode</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_double</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">mymod</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>The test is run by executing the test file <tt class="docutils literal"><span class="pre">test_mymod.py</span></tt> as a standard
Python program. There is no support in <tt class="docutils literal"><span class="pre">unittest</span></tt> for automatically
locating and running all tests in all test files in a directory tree.</p>
<p>Those who have experience with object-oriented programming will see that
the difference between using <tt class="docutils literal"><span class="pre">unittest</span></tt> and <tt class="docutils literal"><span class="pre">nose</span></tt> is minor.</p>
</div>
<div class="section" id="demonstration-of-unittest">
<h4>Demonstration of unittest<a class="headerlink" href="#demonstration-of-unittest" title="Permalink to this headline">¶</a></h4>
<p>The same tests as shown for the nose framework are reimplemented
with the <tt class="docutils literal"><span class="pre">TestCase</span></tt> classes in the file <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/tests/test_decay_nose.py">test_decay_unittest.py</a>.
The tests are identical, the only difference being that with
<tt class="docutils literal"><span class="pre">unittest</span></tt> we must write the tests as methods in
a class and the assert functions have
slightly different names.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">decay_mod_unittest</span> <span class="kn">as</span> <span class="nn">decay</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">exact_discrete_solution</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">factor</span><span class="o">**</span><span class="n">n</span>

<span class="k">class</span> <span class="nc">TestDecay</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_exact_discrete_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_de</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1E-14</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
            <span class="o">...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                   <span class="n">msg</span><span class="o">=</span><span class="s">&#39;theta=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">theta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_potential_integer_division</span><span class="p">():</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1E-14</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_convergence_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="o">...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="implementing-simple-problem-and-solver-classes">
<span id="decay-prog-se-class"></span><h3>Implementing simple problem and solver classes<a class="headerlink" href="#implementing-simple-problem-and-solver-classes" title="Permalink to this headline">¶</a></h3>
<p>The <span class="math">\(\theta\)</span>-rule was compactly and conveniently implemented in
a function <tt class="docutils literal"><span class="pre">solver</span></tt> in the section <em class="xref std std-ref">decay:py1</em>.
In more complicated problems it might
be beneficial to use classes and introduce a class <tt class="docutils literal"><span class="pre">Problem</span></tt> to
hold the definition of the physical problem, a class <tt class="docutils literal"><span class="pre">Solver</span></tt>
to hold the data and methods needed to numerically solve the problem,
and a class <tt class="docutils literal"><span class="pre">Visualizer</span></tt> to make plots.
This idea will now be illustrated, resulting in code that represents
an alternative to the <tt class="docutils literal"><span class="pre">solver</span></tt> and <tt class="docutils literal"><span class="pre">explore</span></tt> functions found
in the <tt class="docutils literal"><span class="pre">decay_mod</span></tt> module.</p>
<p>Explaining the details of class programming in Python is considered
beyond the scope of this text.  Readers who are unfamiliar with Python
class programming should first consult one of the many electronic
Python tutorials or textbooks to come up to speed with concepts and
syntax of Python classes before reading on. The author has a gentle
introduction to class programming for scientific applications
in <a class="reference internal" href="#ref1" id="id2">[Ref1]</a>, see Chapter 7 and 9 and Appendix E.
Other useful resources are</p>
<blockquote>
<div><ul class="simple">
<li>The Python Tutorial: <a class="reference external" href="http://docs.python.org/2/tutorial/classes.html">http://docs.python.org/2/tutorial/classes.html</a></li>
<li>Wiki book on Python Programming: <a class="reference external" href="http://en.wikibooks.org/wiki/Python_Programming/Classes">http://en.wikibooks.org/wiki/Python_Programming/Classes</a></li>
<li>tutorialspoint.com: <a class="reference external" href="http://www.tutorialspoint.com/python/python_classes_objects.htm">http://www.tutorialspoint.com/python/python_classes_objects.htm</a></li>
</ul>
</div></blockquote>
<div class="section" id="the-problem-class-1">
<h4>The problem class  (1)<a class="headerlink" href="#the-problem-class-1" title="Permalink to this headline">¶</a></h4>
<p id="index-28">The purpose of the problem class is to store all information about
the mathematical model. This usually means all the physical parameters
in the problem. In the current example with exponential decay we may
also add the exact solution of the ODE to the problem class.
The simplest form of a problem class is therefore</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span>

<span class="k">class</span> <span class="nc">Problem</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">I</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">T</span>

    <span class="k">def</span> <span class="nf">u_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>We could in the <tt class="docutils literal"><span class="pre">u_exact</span></tt> method have written
<tt class="docutils literal"><span class="pre">self.I*exp(-self.a*t)</span></tt>, but using local variables <tt class="docutils literal"><span class="pre">I</span></tt> and <tt class="docutils literal"><span class="pre">a</span></tt> allows
the formula <tt class="docutils literal"><span class="pre">I*exp(-a*t)</span></tt> which looks closer to the mathematical
expression <span class="math">\(Ie^{-at}\)</span>.  This is not an important issue with the
current compact formula, but is beneficial in more complicated
problems with longer formulas to obtain the closest possible
relationship between code and mathematics. My coding style is to strip
off the <tt class="docutils literal"><span class="pre">self</span></tt> prefix when the code expresses mathematical formulas.</p>
<p>The class data can be set either as arguments in the constructor or
at any time later, e.g.,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">problem</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">problem</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">problem</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.5</span>
</pre></div>
</div>
<p>(Some programmers prefer <tt class="docutils literal"><span class="pre">set</span></tt> and <tt class="docutils literal"><span class="pre">get</span></tt> functions for setting and getting
data in classes, often implemented via <em>properties</em> in Python, but
I consider that overkill when we just have a few data items in a class.)</p>
<p>It would be convenient if class <tt class="docutils literal"><span class="pre">Problem</span></tt> could also initialize
the data from the command line. To this end, we add a method for
defining a set of command-line options and a method that sets the
local attributes equal to what was found on the command line.
The default values associated with the command-line options are taken
as the values provided to the constructor. Class <tt class="docutils literal"><span class="pre">Problem</span></tt> now becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Problem</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">I</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">T</span>

    <span class="k">def</span> <span class="nf">define_command_line_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">argparse</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s">&#39;--I&#39;</span><span class="p">,</span> <span class="s">&#39;--initial_condition&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;initial condition, u(0)&#39;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;I&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s">&#39;--a&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;coefficient in ODE&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s">&#39;--T&#39;</span><span class="p">,</span> <span class="s">&#39;--stop_time&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;end time of simulation&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span>

    <span class="k">def</span> <span class="nf">init_from_command_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">exact_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>Observe that if the user already has an <tt class="docutils literal"><span class="pre">ArgumentParser</span></tt> object it can be
supplied, but if she does not have any, class <tt class="docutils literal"><span class="pre">Problem</span></tt> makes one.
Python&#8217;s <tt class="docutils literal"><span class="pre">None</span></tt> object is used to indicate that a variable is not
initialized with a proper value.</p>
</div>
<div class="section" id="the-solver-class-1">
<h4>The solver class  (1)<a class="headerlink" href="#the-solver-class-1" title="Permalink to this headline">¶</a></h4>
<span class="target" id="index-29"></span><p id="index-30">The solver class stores data related to the numerical solution method
and provides a function <tt class="docutils literal"><span class="pre">solve</span></tt> for solving the problem.
A problem object must be given to the constructor so that the solver
can easily look up physical data. In the present example, the
data related to the numerical solution method consists of <span class="math">\(\Delta t\)</span>
and <span class="math">\(\theta\)</span>. We add, as in the problem class, functionality for
reading <span class="math">\(\Delta t\)</span> and <span class="math">\(\theta\)</span> from the command line:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Solver</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">theta</span>

    <span class="k">def</span> <span class="nf">define_command_line_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s">&#39;--dt&#39;</span><span class="p">,</span> <span class="s">&#39;--time_step_value&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;time step value&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;dt&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s">&#39;--theta&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;time discretization parameter&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;dt&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span>

    <span class="k">def</span> <span class="nf">init_from_command_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">theta</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">decay_mod</span> <span class="kn">import</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">u_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">exact_solution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">u_e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">E</span>
</pre></div>
</div>
<p>Note that we here simply reuse the implementation of the numerical method
from the <tt class="docutils literal"><span class="pre">decay_mod</span></tt> module. The <tt class="docutils literal"><span class="pre">solve</span></tt> function is just a <em>wrapper</em>
of the previously developed stand-alone <tt class="docutils literal"><span class="pre">solver</span></tt> function.</p>
</div>
<div class="section" id="the-visualizer-class-1">
<h4>The visualizer class  (1)<a class="headerlink" href="#the-visualizer-class-1" title="Permalink to this headline">¶</a></h4>
<p id="index-31">The purpose of the visualizer class is to plot the numerical solution
stored in class <tt class="docutils literal"><span class="pre">Solver</span></tt>. We also add the possibility to plot the
exact solution. Access to the problem and solver objects is required
when making plots so the constructor must hold references to these objects:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Visualizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">problem</span><span class="p">,</span> <span class="n">solver</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_exact</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">plt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add solver.u curve to the plotting object plt,</span>
<span class="sd">        and include the exact solution if include_exact is True.</span>
<span class="sd">        This plot function can be called several times (if</span>
<span class="sd">        the solver object has computed new solutions).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">plt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">scitools.std</span>  <span class="kn">as</span> <span class="nn">plt</span> <span class="c"># can use matplotlib as well</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="s">&#39;--o&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">)</span>
        <span class="n">theta2name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;FE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;BE&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s">&#39;CN&#39;</span><span class="p">}</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">theta2name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">legends</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;numerical </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_exact</span><span class="p">:</span>
            <span class="n">t_e</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
            <span class="n">u_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">exact_solution</span><span class="p">(</span><span class="n">t_e</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_e</span><span class="p">,</span> <span class="n">u_e</span><span class="p">,</span> <span class="s">&#39;b-&#39;</span><span class="p">)</span>
            <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;exact&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legends</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;theta=</span><span class="si">%g</span><span class="s">, dt=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%g</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">plt</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">plt</span></tt> object in the <tt class="docutils literal"><span class="pre">plot</span></tt> method is worth a comment. The idea is
that <tt class="docutils literal"><span class="pre">plot</span></tt> can add a numerical solution curve to an existing
plot. Calling <tt class="docutils literal"><span class="pre">plot</span></tt> with a <tt class="docutils literal"><span class="pre">plt</span></tt> object (which has to be a
<tt class="docutils literal"><span class="pre">matplotlib.pyplot</span></tt> or <tt class="docutils literal"><span class="pre">scitools.std</span></tt> object in this implementation),
will just add the curve
<tt class="docutils literal"><span class="pre">self.solver.u</span></tt> as a dashed line with circles at the mesh points
(leaving the color of the curve up to the plotting tool). This
functionality allows plots with several solutions: just make a loop
where new data is set in the problem and/or solver classes, the
solver&#8217;s <tt class="docutils literal"><span class="pre">solve()</span></tt> method is called, and the most recent numerical
solution is plotted by the <tt class="docutils literal"><span class="pre">plot(plt)</span></tt> method in the visualizer object
<a class="reference internal" href="#decay-exer-decay-class-exper"><em>Exercise 6: Make use of a class implementation</em></a> describes a problem setting
where this functionality is explored.</p>
</div>
<div class="section" id="combining-the-objects">
<h4>Combining the objects<a class="headerlink" href="#combining-the-objects" title="Permalink to this headline">¶</a></h4>
<p>Eventually we need to show how the classes <tt class="docutils literal"><span class="pre">Problem</span></tt>, <tt class="docutils literal"><span class="pre">Solver</span></tt>, and
<tt class="docutils literal"><span class="pre">Visualizer</span></tt> play together:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">()</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
    <span class="n">viz</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">solver</span><span class="p">)</span>

    <span class="c"># Read input from the command line</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">define_command_line_options</span><span class="p">()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span> <span class="n">define_command_line_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">init_from_command_line</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">solver</span><span class="o">.</span> <span class="n">init_from_command_line</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c"># Solve and plot</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="c">#import scitools.std as plt</span>
    <span class="n">plt</span> <span class="o">=</span> <span class="n">viz</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plt</span><span class="o">=</span><span class="n">plt</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">E</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Error: </span><span class="si">%.4E</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">E</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The file <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_class.py">decay_class.py</a>
constitutes a module with the three classes and the <tt class="docutils literal"><span class="pre">main</span></tt> function.</p>
<div class="admonition-test-the-understanding admonition">
<p class="first admonition-title">Test the understanding</p>
<p class="last">Implement the problem in
<em class="xref std std-ref">decay:app:exer:drag:prog</em> in terms of problem, solver,
and visualizer classes. Equip the classes and their methods with
doc strings with tests. Also include nose tests.</p>
</div>
</div>
</div>
<div class="section" id="improving-the-problem-and-solver-classes">
<span id="decay-prog-se-class2"></span><h3>Improving the problem and solver classes<a class="headerlink" href="#improving-the-problem-and-solver-classes" title="Permalink to this headline">¶</a></h3>
<p>The previous <tt class="docutils literal"><span class="pre">Problem</span></tt> and <tt class="docutils literal"><span class="pre">Solver</span></tt> classes containing parameters
soon get much repetitive code when the number of parameters increases.
Much of this code can be parameterized and be made more compact.
For this purpose, we decide to collect all parameters in a dictionary,
<tt class="docutils literal"><span class="pre">self.prms</span></tt>, with two associated dictionaries <tt class="docutils literal"><span class="pre">self.types</span></tt> and
<tt class="docutils literal"><span class="pre">self.help</span></tt> for holding associated object types and help strings.
Provided a problem, solver, or visualizer class defines these three
dictionaries in the constructor, using default or user-supplied values
of the parameters, we can create a super class <tt class="docutils literal"><span class="pre">Parameters</span></tt> with general code
for defining command-line options and reading them as well as
methods for setting and getting a parameter. A <tt class="docutils literal"><span class="pre">Problem</span></tt> or <tt class="docutils literal"><span class="pre">Solver</span></tt> class will
then inherit command-line functionality and the set/get methods from
the <tt class="docutils literal"><span class="pre">Parameters</span></tt> class.</p>
<div class="section" id="a-generic-class-for-parameters">
<h4>A generic class for parameters<a class="headerlink" href="#a-generic-class-for-parameters" title="Permalink to this headline">¶</a></h4>
<p>A simplified version of the parameter class looks as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Parameters</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prms</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prms</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">define_command_line_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">argparse</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prms</span><span class="p">:</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="k">else</span> <span class="nb">str</span>
            <span class="n">help</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s">&#39;--&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">metavar</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span>

    <span class="k">def</span> <span class="nf">init_from_command_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prms</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>The file <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/class_decay_oo.py">class_decay_oo.py</a> contains
a slightly more advanced version of class <tt class="docutils literal"><span class="pre">Parameters</span></tt> where we
in the <tt class="docutils literal"><span class="pre">set</span></tt> and <tt class="docutils literal"><span class="pre">get</span></tt> functions test for valid parameter names and
raise exceptions with informative messages if any name is not registered.</p>
</div>
<div class="section" id="the-problem-class-2">
<h4>The problem class  (2)<a class="headerlink" href="#the-problem-class-2" title="Permalink to this headline">¶</a></h4>
<p id="index-32">A class <tt class="docutils literal"><span class="pre">Problem</span></tt> for the problem <span class="math">\(u'=-au\)</span>, <span class="math">\(u(0)=I\)</span>, <span class="math">\(t\in (0,T]\)</span>, with
parameters input <span class="math">\(a\)</span>, <span class="math">\(I\)</span>, and <span class="math">\(T\)</span> can now be coded as</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Problem</span><span class="p">(</span><span class="n">Parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Physical parameters for the problem u&#39;=-a*u, u(0)=I,</span>
<span class="sd">    with t in [0,T].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="s">&#39;initial condition, u(0)&#39;</span><span class="p">,</span>
                         <span class="n">a</span><span class="o">=</span><span class="s">&#39;coefficient in ODE&#39;</span><span class="p">,</span>
                         <span class="n">T</span><span class="o">=</span><span class="s">&#39;end time of simulation&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exact_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-solver-class-2">
<h4>The solver class  (2)<a class="headerlink" href="#the-solver-class-2" title="Permalink to this headline">¶</a></h4>
<p id="index-33">Also the solver class is derived from class <tt class="docutils literal"><span class="pre">Parameters</span></tt> and works with
the <tt class="docutils literal"><span class="pre">prms</span></tt>, <tt class="docutils literal"><span class="pre">types</span></tt>, and <tt class="docutils literal"><span class="pre">help</span></tt> dictionaries in the same way as class
<tt class="docutils literal"><span class="pre">Problem</span></tt>. Otherwise, the code is very similar to class <tt class="docutils literal"><span class="pre">Solver</span></tt> in
the <tt class="docutils literal"><span class="pre">decay_class.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Solver</span><span class="p">(</span><span class="n">Parameters</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="s">&#39;time step value&#39;</span><span class="p">,</span>
                         <span class="n">theta</span><span class="o">=</span><span class="s">&#39;time discretization parameter&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">decay_mod</span> <span class="kn">import</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dt&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">u_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">exact_solution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">u_e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dt&#39;</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">E</span>
</pre></div>
</div>
</div>
<div class="section" id="the-visualizer-class-2">
<h4>The visualizer class  (2)<a class="headerlink" href="#the-visualizer-class-2" title="Permalink to this headline">¶</a></h4>
<p id="index-34">Class <tt class="docutils literal"><span class="pre">Visualizer</span></tt> can be identical to the one in the <tt class="docutils literal"><span class="pre">decay_class.py</span></tt> file
since the class does not need any parameters. However, a few
adjustments in the <tt class="docutils literal"><span class="pre">plot</span></tt> method is necessary since parameters are
accessed as, e.g., <tt class="docutils literal"><span class="pre">problem.get('T')</span></tt> rather than <tt class="docutils literal"><span class="pre">problem.T</span></tt>.
The details are found in the file <tt class="docutils literal"><span class="pre">class_decay_oo.py</span></tt>.</p>
<p>Finally, we need a function that solves a real problem using the
classes <tt class="docutils literal"><span class="pre">Problem</span></tt>, <tt class="docutils literal"><span class="pre">Solver</span></tt>, and <tt class="docutils literal"><span class="pre">Visualizer</span></tt>. This function can
be just like <tt class="docutils literal"><span class="pre">main</span></tt> in the <tt class="docutils literal"><span class="pre">decay_class.py</span></tt> file.</p>
<p>The advantage with the <tt class="docutils literal"><span class="pre">Parameters</span></tt> class is that it scales to problems
with a large number of physical and numerical parameters:
as long as the parameters are defined once via a dictionary,
the compact code in class <tt class="docutils literal"><span class="pre">Parameters</span></tt> can handle any collection of
parameters of any size.</p>
</div>
</div>
</div>
<div class="section" id="performing-scientific-experiments">
<span id="decay-experiments"></span><h2>Performing scientific experiments<a class="headerlink" href="#performing-scientific-experiments" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-35"></span><div class="admonition-goal admonition" id="index-36">
<p class="first admonition-title">Goal</p>
<p>This section explores the behavior of a numerical
method for a differential equation through computer experiments.
In particular, it is shown how scientific experiments
can be set up and reported. We address the ODE problem</p>
<div class="math" id="equation-decay:experiments:model">
<span class="eqno">(5)</span>\[     u'(t) = -au(t),\quad u(0)=I,\quad t\in (0,T],\]</div>
<p>numerically discretized by the <span class="math">\(\theta\)</span>-rule:</p>
<div class="math">
\[u^{n+1} = \frac{1 - (1-\theta) a\Delta t}{1 + \theta a\Delta t}u^n,
\quad u^0=I{\thinspace .}\]</div>
<p class="last">Our aim is to plot <span class="math">\(u^0,u^1,\ldots,u^N\)</span>
together with the exact solution <span class="math">\({u_{\small\mbox{e}}} = Ie^{-at}\)</span>
for various choices of the parameters in this numerical problem:
<span class="math">\(I\)</span>, <span class="math">\(a\)</span>, <span class="math">\(\Delta t\)</span>, and <span class="math">\(\theta\)</span>. We are especially interested
in how the discrete solution compares with the exact solution
when the <span class="math">\(\Delta t\)</span> parameter is varied and <span class="math">\(\theta\)</span> takes on the three values
corresponding to the Forward Euler, Backward Euler, and Crank-Nicolson
schemes (<span class="math">\(\theta=0,1,0.5\)</span>, respectively).</p>
</div>
<div class="section" id="software">
<h3>Software<a class="headerlink" href="#software" title="Permalink to this headline">¶</a></h3>
<p>A verified implementation for computing the numerical
solution <span class="math">\(u^n\)</span> and plotting it together
with the exact solution <span class="math">\({u_{\small\mbox{e}}}\)</span> is found in the file
<a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/decay_mod.py">decay_mod.py</a>.
This program admits command-line arguments to specify a series of
<span class="math">\(\Delta t\)</span> values and will run a loop over these values and
<span class="math">\(\theta=0,0.5,1\)</span>. We make a slight edit of how the plots are
designed: the numerical solution is specified with line type <tt class="docutils literal"><span class="pre">'r--o'</span></tt>
(dashed red lines with dots at the mesh points), and the <tt class="docutils literal"><span class="pre">show()</span></tt>
command is removed to avoid a lot of plot windows popping up on
the computer screen (but hardcopies of the plot are still stored
in files via <tt class="docutils literal"><span class="pre">savefig</span></tt>). The slightly
modified program has the name
<a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/experiments/decay_mod.py">experiments/decay_mod.py</a>.
All files associated with the scientific investigation are collected
in a subdirectory <tt class="docutils literal"><span class="pre">experiments</span></tt>.</p>
<p>Running the experiments is easy since the <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt> program
already has the loops over <span class="math">\(\theta\)</span> and <span class="math">\(\Delta t\)</span> implemented.
An experiment with <span class="math">\(I=1\)</span>, <span class="math">\(a=2\)</span>, <span class="math">\(T=5\)</span>, and <span class="math">\(dt=0.5, 0.25, 0.1, 0.05\)</span>
is run by</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_mod.py --I 1 --a 2 --makeplot \
          --T 5 --dt 0.5 0.25 0.1 0.05
</pre></div>
</div>
</div>
<div class="section" id="combining-plot-files">
<h3>Combining plot files<a class="headerlink" href="#combining-plot-files" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt> program generates a lot of image files, e.g.,
<tt class="docutils literal"><span class="pre">FE_*.png</span></tt>, <tt class="docutils literal"><span class="pre">BE_*.png</span></tt>, and <tt class="docutils literal"><span class="pre">CN_*.png</span></tt>.
We want to combine all the <tt class="docutils literal"><span class="pre">FE_*.png</span></tt> files in a table
fashion in one file, with two images in each row,
starting with the largest <span class="math">\(\Delta t\)</span> in the upper
left corner and decreasing the value as we go to the right and down.
This can be done using the <a class="reference external" href="http://www.imagemagick.org/script/montage.php">montage</a> program. The often occurring white areas around the plots can
be cropped away by the <tt class="docutils literal"><span class="pre">convert</span> <span class="pre">-trim</span></tt> command.
The remaining white can be made transparent for HTML pages with a
non-white background by the command <tt class="docutils literal"><span class="pre">convert</span> <span class="pre">-transparent</span> <span class="pre">white</span></tt>.</p>
<p>Also plot files in the PDF format with names <tt class="docutils literal"><span class="pre">FE_*.pdf</span></tt>, <tt class="docutils literal"><span class="pre">BE_*.pdf</span></tt>,
and <tt class="docutils literal"><span class="pre">CN_*.pdf</span></tt> are generated and these should be combined using other
tools: <tt class="docutils literal"><span class="pre">pdftk</span></tt> to combine individual plots into one file with one plot
per page, and <tt class="docutils literal"><span class="pre">pdfnup</span></tt> to combine the pages into a table with multiple
plots per page. The resulting image often has some extra surrounding
white space that can be removed by the <tt class="docutils literal"><span class="pre">pdfcrop</span></tt> program.
The code snippets below contain all details about the
usage of <tt class="docutils literal"><span class="pre">montage</span></tt>, <tt class="docutils literal"><span class="pre">convert</span></tt>, <tt class="docutils literal"><span class="pre">pdftk</span></tt>, <tt class="docutils literal"><span class="pre">pdfnup</span></tt>, and <tt class="docutils literal"><span class="pre">pdfcrop</span></tt>.</p>
<p id="index-37">Running manual commands is boring, and errors may easily
sneak in. Both for automating manual work and documenting the
operating system commands we actually issued in the experiment,
we should write a <em>script</em> (little program). An alternative is
to write the commands into an IPython notebook and use the
notebook as the script. A plain script as a standard Python
program in a separate text file will be used here.</p>
<div class="admonition-reproducible-science admonition">
<p class="first admonition-title">Reproducible science</p>
<p class="last">A script that automates running our computer experiments
will ensure
that the experiments can easily be rerun by ourselves or others in
the future, either to check the results or redo the experiments with
other input data. Also, whatever we did to produce the results is
documented in every detail in the script.
Automating scripts are therefore essential to making our
research <em>reproducible</em>, which is a fundamental principle in science.</p>
</div>
<p>The script takes
a list of <span class="math">\(\Delta t\)</span> values on the command line as input and
makes three combined images, one for each <span class="math">\(\theta\)</span> value,
displaying the quality of the numerical solution as <span class="math">\(\Delta t\)</span>
varies. For example,</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python decay_exper0.py 0.5 0.25 0.1 0.05
</pre></div>
</div>
<p>results in images <tt class="docutils literal"><span class="pre">FE.png</span></tt>, <tt class="docutils literal"><span class="pre">CN.png</span></tt>, <tt class="docutils literal"><span class="pre">BE.png</span></tt>,
<tt class="docutils literal"><span class="pre">FE.pdf</span></tt>, <tt class="docutils literal"><span class="pre">CN.pdf</span></tt>, and <tt class="docutils literal"><span class="pre">BE.pdf</span></tt>,
each with four plots corresponding to the four <span class="math">\(\Delta t\)</span> values.
Each plot compares the numerical solution with the exact one.
The latter image is shown in Figure <a class="reference internal" href="#decay-experiments-fig-be4a"><em>Illustration of the Backward Euler method for four time step values</em></a>.</p>
<div class="figure" id="decay-experiments-fig-be4a">
<a class="reference internal image-reference" href="_images/BE4a.png"><img alt="_images/BE4a.png" src="_images/BE4a.png" style="width: 600px;" /></a>
<p class="caption"><em>Illustration of the Backward Euler method for four time step values</em></p>
</div>
<p>Ideally, the script should be scalable in the sense that it works for
any number of <span class="math">\(\Delta t\)</span> values, which is the case for this particular
implementation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">run_experiments</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="c"># The command line must contain dt values</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dt_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Usage: </span><span class="si">%s</span><span class="s"> dt1 dt2 dt3 ...&#39;</span> <span class="o">%</span>  <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># abort</span>

    <span class="c"># Run module file as a stand-alone application</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;python decay_mod.py --I </span><span class="si">%g</span><span class="s"> --a </span><span class="si">%g</span><span class="s"> --makeplot --T </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">dt_values_str</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">])</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="s">&#39; --dt </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">dt_values_str</span>
    <span class="k">print</span> <span class="n">cmd</span>
    <span class="n">failure</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Command failed:&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Combine images into rows with 2 plots in each row</span>
    <span class="n">image_commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="s">&#39;BE&#39;</span><span class="p">,</span> <span class="s">&#39;CN&#39;</span><span class="p">,</span> <span class="s">&#39;FE&#39;</span><span class="p">:</span>
        <span class="n">pdf_files</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%g</span><span class="s">.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">])</span>
        <span class="n">png_files</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%g</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_values</span><span class="p">])</span>
        <span class="n">image_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s">&#39;montage -background white -geometry 100%&#39;</span> <span class="o">+</span>
            <span class="s">&#39; -tile 2x </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">png_files</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
        <span class="n">image_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s">&#39;convert -trim </span><span class="si">%s</span><span class="s">.png </span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
        <span class="n">image_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s">&#39;convert </span><span class="si">%s</span><span class="s">.png -transparent white </span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
        <span class="n">image_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s">&#39;pdftk </span><span class="si">%s</span><span class="s"> output tmp.pdf&#39;</span> <span class="o">%</span> <span class="n">pdf_files</span><span class="p">)</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt_values</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>
        <span class="n">image_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s">&#39;pdfnup --nup 2x</span><span class="si">%d</span><span class="s"> tmp.pdf&#39;</span> <span class="o">%</span> <span class="n">num_rows</span><span class="p">)</span>
        <span class="n">image_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s">&#39;pdfcrop tmp-nup.pdf </span><span class="si">%s</span><span class="s">.pdf&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">image_commands</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">cmd</span>
        <span class="n">failure</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Command failed:&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Remove the files generated above and by decay_mod.py</span>
    <span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s">&#39;*_*.png&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="p">(</span><span class="s">&#39;*_*.pdf&#39;</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">glob</span><span class="p">(</span><span class="s">&#39;*_*.eps&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="p">(</span><span class="s">&#39;tmp*.pdf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">run_experiments</span><span class="p">()</span>
</pre></div>
</div>
<p>This file is available as <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/experiments/decay_exper0.py">experiments/decay_exper0.py</a>.</p>
<span class="target" id="index-38"></span><span class="target" id="index-39"></span><p id="index-40">We may comment upon many useful constructs in this script:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">[float(arg)</span> <span class="pre">for</span> <span class="pre">arg</span> <span class="pre">in</span> <span class="pre">sys.argv[1:]]</span></tt> builds a list of real numbers
from all the command-line arguments.</li>
<li><tt class="docutils literal"><span class="pre">failure</span> <span class="pre">=</span> <span class="pre">os.system(cmd)</span></tt> runs an operating system command, e.g.,
another program. The execution is successful only if <tt class="docutils literal"><span class="pre">failure</span></tt> is zero.</li>
<li>Unsuccessful execution usually makes it meaningless to continue
the program, and therefore we abort the program with <tt class="docutils literal"><span class="pre">sys.exit(1)</span></tt>.
Any argument different from 0 signifies to the computer&#8217;s operating system
that our program stopped with a failure.</li>
<li><tt class="docutils literal"><span class="pre">['%s_%s.png'</span> <span class="pre">%</span> <span class="pre">(method,</span> <span class="pre">dt)</span> <span class="pre">for</span> <span class="pre">dt</span> <span class="pre">in</span> <span class="pre">dt_values]</span></tt> builds a list of
filenames from a list of numbers (<tt class="docutils literal"><span class="pre">dt_values</span></tt>).</li>
<li>All <tt class="docutils literal"><span class="pre">montage</span></tt>, <tt class="docutils literal"><span class="pre">convert</span></tt>, <tt class="docutils literal"><span class="pre">pdftk</span></tt>, <tt class="docutils literal"><span class="pre">pdfnup</span></tt>, and <tt class="docutils literal"><span class="pre">pdfcrop</span></tt>
commands for creating
composite figures are stored in a
list and later executed in a loop.</li>
<li><tt class="docutils literal"><span class="pre">glob('*_*.png')</span></tt> returns a list of the names of all files in the
current directory where the filename matches the <a class="reference external" href="http://en.wikipedia.org/wiki/Glob_(programming)">Unix wildcard notation</a>
<tt class="docutils literal"><span class="pre">*_*.png</span></tt> (meaning any text, underscore, any text, and then <tt class="docutils literal"><span class="pre">.png</span></tt>).</li>
<li><tt class="docutils literal"><span class="pre">os.remove(filename)</span></tt> removes the file with name <tt class="docutils literal"><span class="pre">filename</span></tt>.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="interpreting-output-from-other-programs">
<h3>Interpreting output from other programs<a class="headerlink" href="#interpreting-output-from-other-programs" title="Permalink to this headline">¶</a></h3>
<p>Programs that run other programs, like <tt class="docutils literal"><span class="pre">decay_exper0.py</span></tt> does, will often
need to interpret output from those programs. Let us demonstrate how
this is done in Python by extracting the relations between <span class="math">\(\theta\)</span>,
<span class="math">\(\Delta t\)</span>, and the error <span class="math">\(E\)</span> as written to the terminal window
by the <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt> program, when being executed by
<tt class="docutils literal"><span class="pre">decay_exper0.py</span></tt>. We will</p>
<blockquote>
<div><ul class="simple">
<li>read the output from the <tt class="docutils literal"><span class="pre">decay_mod.py</span></tt> program</li>
<li>interpret this output and store the <span class="math">\(E\)</span> values in arrays for each
<span class="math">\(\theta\)</span> value</li>
<li>plot <span class="math">\(E\)</span> versus <span class="math">\(\Delta t\)</span>, for each <span class="math">\(\theta\)</span>, in a log-log plot</li>
</ul>
</div></blockquote>
<span class="target" id="index-41"></span><p id="index-42">The simple <tt class="docutils literal"><span class="pre">os.system(cmd)</span></tt> call does not allow us to read the
output from running <tt class="docutils literal"><span class="pre">cmd</span></tt>. Instead we need to invoke a bit more
involved procedure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">STDOUT</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">)</span>
<span class="n">output</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
<span class="n">failure</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span>
<span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;Command failed:&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The command stored in <tt class="docutils literal"><span class="pre">cmd</span></tt> is run and all text that is written to
the standard output <em>and</em> the standard error is available in the
string <tt class="docutils literal"><span class="pre">output</span></tt>. Or in other words, the text in <tt class="docutils literal"><span class="pre">output</span></tt> is what appeared in the
terminal window while running <tt class="docutils literal"><span class="pre">cmd</span></tt>.</p>
<p>Our next task is to run through the <tt class="docutils literal"><span class="pre">output</span></tt> string, line by line,
and if the current line prints <span class="math">\(\theta\)</span>, <span class="math">\(\Delta t\)</span>, and <span class="math">\(E\)</span>,
we split the line into these three pieces and store the data.
The chosen storage structure is a dictionary <tt class="docutils literal"><span class="pre">errors</span></tt> with keys <tt class="docutils literal"><span class="pre">dt</span></tt>
to hold the <span class="math">\(\Delta t\)</span> values in a list, and three <span class="math">\(\theta\)</span> keys to hold
the corresponding <span class="math">\(E\)</span> values in a list. The relevant code lines are</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt_values</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">:</span> <span class="p">[],</span> <span class="mf">0.5</span><span class="p">:</span> <span class="p">[]}</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;0.0&#39;</span><span class="p">,</span> <span class="s">&#39;0.5&#39;</span><span class="p">,</span> <span class="s">&#39;1.0&#39;</span><span class="p">):</span>  <span class="c"># line with E?</span>
        <span class="c"># typical line: 0.0   1.25:    7.463E+00</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">E</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">errors</span><span class="p">[</span><span class="n">theta</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we do not bother to store the <span class="math">\(\Delta t\)</span> values as we
read them from <tt class="docutils literal"><span class="pre">output</span></tt>, because we already have these values in
the <tt class="docutils literal"><span class="pre">dt_values</span></tt> list.</p>
<p>We are now ready to plot <span class="math">\(E\)</span> versus <span class="math">\(\Delta t\)</span> for <span class="math">\(\theta=0,0.5,1\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;ro-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="mf">0.5</span><span class="p">],</span> <span class="s">&#39;b+-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;gx-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&#39;FE&#39;</span><span class="p">,</span> <span class="s">&#39;CN&#39;</span><span class="p">,</span> <span class="s">&#39;BE&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;log(time step)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;log(error)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Error vs time step&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;error.png&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;error.pdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Plots occasionally need some manual adjustments. Here, the axis of
the log-log plot look nicer if we adapt them strictly to the data,
see Figure <a class="reference internal" href="#decay-exper-evsdt"><em>Default plot (left) and manually adjusted axes (right)</em></a>.
To this end, we need to compute <span class="math">\(\min E\)</span> and <span class="math">\(\max E\)</span>, and later
specify the extent of the axes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Find min/max for the axis</span>
<span class="n">E_min</span> <span class="o">=</span> <span class="mf">1E+20</span><span class="p">;</span> <span class="n">E_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">E_min</span>
<span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">E_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">E_min</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">theta</span><span class="p">]))</span>
    <span class="n">E_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">E_max</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">theta</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;ro-&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">dt_values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">dt_values</span><span class="p">),</span> <span class="n">E_min</span><span class="p">,</span> <span class="n">E_max</span><span class="p">])</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="figure" id="decay-exper-evsdt">
<a class="reference internal image-reference" href="_images/error_plot_improvement.png"><img alt="_images/error_plot_improvement.png" src="_images/error_plot_improvement.png" style="width: 800px;" /></a>
<p class="caption"><em>Default plot (left) and manually adjusted axes (right)</em></p>
</div>
<p>The complete program, incorporating the code snippets above, is found
in <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/experiments/decay_exper1.py">experiments/decay_exper1.py</a>.
This example can hopefully act as template for numerous
other occasions
where one needs to run experiments, extract data from the output
of programs, make plots, and combine several plots in a figure file.
The <tt class="docutils literal"><span class="pre">decay_exper1.py</span></tt> program
is organized as a module, and other files can then easily extend
the functionality, as illustrated in the next section.</p>
</div>
<div class="section" id="making-a-report">
<span id="decay-exper-report"></span><h3>Making a report<a class="headerlink" href="#making-a-report" title="Permalink to this headline">¶</a></h3>
<p>The results of running computer experiments are best documented in a
little report containing the problem to be solved, key code segments,
and the plots from a series of experiments. At least the part of the
report containing the plots should be automatically generated by the
script that performs the set of experiments, because in that script we
know exactly which input data that were used to generate a specific
plot, thereby ensuring that each figure is connected to the
right data. Take a look at an
example at <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//sphinx-cloud/">http://tinyurl.com/k3sdbuv/writing_reports//sphinx-cloud/</a>  to see what we have in
mind.</p>
<div class="section" id="plain-html">
<h4>Plain HTML<a class="headerlink" href="#plain-html" title="Permalink to this headline">¶</a></h4>
<p>Scientific reports can be written in a variety of formats. Here we
begin with the <a class="reference external" href="http://en.wikipedia.org/wiki/HTML">HTML</a> format
which allows efficient viewing of all the experiments in any web
browser. The program
<a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/experiments/decay_exper1_html.py">decay_exper1_html.py</a> calls
<tt class="docutils literal"><span class="pre">decay_exper1.py</span></tt> to perform the experiments and then runs
statements for creating an HTML file with a summary, a
section on the mathematical problem, a section on the numerical
method, a section on the <tt class="docutils literal"><span class="pre">solver</span></tt> function implementing the
method, and a section with subsections containing figures that show
the results of experiments where <span class="math">\(\Delta t\)</span> is varied for
<span class="math">\(\theta=0,0.5,1\)</span>. The mentioned
Python file contains all the details for writing
this <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report_html.html.html">HTML report</a>.
You can view the report on <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report_html.html">http://tinyurl.com/k3sdbuv/writing_reports//_static/report_html.html</a>.</p>
</div>
<div class="section" id="html-with-mathjax">
<h4>HTML with MathJax<a class="headerlink" href="#html-with-mathjax" title="Permalink to this headline">¶</a></h4>
<p>Scientific reports usually need mathematical formulas and hence
mathematical typesetting. In plain HTML, as used in the
<tt class="docutils literal"><span class="pre">decay_exper1_html.py</span></tt> file, we have to use just the keyboard
characters to write mathematics. However, there is an extension to
HTML, called <a class="reference external" href="http://www.mathjax.org/">MathJax</a>, which allows
formulas and equations to be typeset with LaTeX syntax and nicely
rendered in web browsers, see Figure
<a class="reference internal" href="#decay-exper-report-fig-mathjax"><em>Report in HTML format with MathJax</em></a>.  A relatively small subset of
LaTeX environments is supported, but the syntax for formulas is quite
rich. Inline formulas are look like <tt class="docutils literal"><span class="pre">\(</span> <span class="pre">u'=-au</span> <span class="pre">\)</span></tt> while equations are
surrounded by <tt class="docutils literal"><span class="pre">$$</span></tt> signs.  Inside such signs, one can use <tt class="docutils literal"><span class="pre">\[</span> <span class="pre">u'=-au</span>
<span class="pre">\]</span></tt> for unnumbered equations, or <tt class="docutils literal"><span class="pre">\begin{equation}</span></tt> and
<tt class="docutils literal"><span class="pre">\end{equation}</span></tt> surrounding <tt class="docutils literal"><span class="pre">u'=-au</span></tt> for numbered equations, or
<tt class="docutils literal"><span class="pre">\begin{equation}</span></tt> and <tt class="docutils literal"><span class="pre">\end{equation}</span></tt> for multiple aligned equations.  You
need to be familiar with <a class="reference external" href="http://en.wikibooks.org/wiki/LaTeX/Mathematics">mathematical typesetting in LaTeX</a>.</p>
<p>The file <a class="reference external" href="http://tinyurl.com/jvzzcfn/softeng1/experiments/decay_exper1_html.py">decay_exper1_mathjax.py</a> contains all the
details for turning the previous plain HTML report into <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report_mathjax.html">web pages
with nicely typeset mathematics</a>.  The
<a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report_mathjax.html.html">corresponding HTML code</a> be studied
to see all details of the mathematical typesetting.</p>
<div class="figure" id="decay-exper-report-fig-mathjax">
<a class="reference internal image-reference" href="_images/report_mathjax.png"><img alt="_images/report_mathjax.png" src="_images/report_mathjax.png" style="width: 600px;" /></a>
<p class="caption"><em>Report in HTML format with MathJax</em></p>
</div>
</div>
<div class="section" id="latex">
<h4>LaTeX<a class="headerlink" href="#latex" title="Permalink to this headline">¶</a></h4>
<p>The <em>de facto</em> language for mathematical typesetting and scientific
report writing is <a class="reference external" href="http://en.wikipedia.org/wiki/LaTeX">LaTeX</a>. A
number of very sophisticated packages have been added to the language
over a period of three decades, allowing very fine-tuned layout and
typesetting. For output in the <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report.pdf">PDF format</a>, see Figure
<a class="reference internal" href="#decay-exper-report-fig-latex"><em>Report in PDF format generated from LaTeX source</em></a> for an example, LaTeX is the
definite choice when it comes to quality. The LaTeX language used to
write the reports has typically a lot of commands involving
<a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report.tex.html">backslashes and braces</a>.  For output on
the web, using HTML (and not the PDF directly in the browser window),
LaTeX struggles with delivering high quality typesetting. Other tools,
especially Sphinx, give better results and can also produce
nice-looking PDFs.  The file <tt class="docutils literal"><span class="pre">decay_exper1_latex.py</span></tt> shows how to
generate the LaTeX source from a program.</p>
<div class="figure" id="decay-exper-report-fig-latex">
<a class="reference internal image-reference" href="_images/report_latexpdf.png"><img alt="_images/report_latexpdf.png" src="_images/report_latexpdf.png" style="width: 600px;" /></a>
<p class="caption"><em>Report in PDF format generated from LaTeX source</em></p>
</div>
</div>
<div class="section" id="sphinx">
<h4>Sphinx<a class="headerlink" href="#sphinx" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://sphinx.pocoo.org/">Sphinx</a> is a typesetting language with
similarities to HTML and LaTeX, but with much less tagging. It has
recently become very popular for software documentation and
mathematical reports. Sphinx can utilize LaTeX for mathematical
formulas and equations (via MathJax or PNG images). Unfortunately, the
subset of LaTeX mathematics supported is less than in full MathJax (in
particular, numbering of multiple equations in an <tt class="docutils literal"><span class="pre">align</span></tt> type
environment is not supported).  The <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report_sphinx.rst.html">Sphinx syntax</a> is an extension of
the reStructuredText language. An attractive feature of Sphinx is its
rich support for <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/sphinx-cloud/index.html">fancy layout of web pages</a>. In particular,
Sphinx can easily be combined with various layout <em>themes</em> that give a
certain look and feel to the web site and that offers table of
contents, navigation, and search facilities, see Figure
<a class="reference internal" href="#decay-exper-report-fig-sphinx"><em>Report in HTML format generated from Sphinx source</em></a>.</p>
<div class="figure" id="decay-exper-report-fig-sphinx">
<a class="reference internal image-reference" href="_images/report_sphinx.png"><img alt="_images/report_sphinx.png" src="_images/report_sphinx.png" style="width: 600px;" /></a>
<p class="caption"><em>Report in HTML format generated from Sphinx source</em></p>
</div>
</div>
<div class="section" id="markdown">
<h4>Markdown<a class="headerlink" href="#markdown" title="Permalink to this headline">¶</a></h4>
<p>A recently popular format for easy writing of web pages is
<a class="reference external" href="http://daringfireball.net/projects/markdown/">Markdown</a>.
Text is written very much like one would do in email, using
spacing and special characters to naturally format the code
instead of heavily tagging the text as in LaTeX and HTML.
With the tool <a class="reference external" href="http://johnmacfarlane.net/pandoc/">Pandoc</a> one
can go from Markdown to a variety of formats.
HTML is a common output format, but LaTeX, epub, XML,
OpenOffice, MediaWiki, and MS Word are some other possibilities.</p>
</div>
<div class="section" id="wiki-formats">
<h4>Wiki formats<a class="headerlink" href="#wiki-formats" title="Permalink to this headline">¶</a></h4>
<p>A range of wiki formats are popular for creating notes on the web,
especially documents which allow groups of people to edit and add
content. Apart from <a class="reference external" href="http://www.mediawiki.org/wiki/MediaWiki">MediaWiki</a> (the wiki format used for
Wikipedia), wiki formats have no support for mathematical typesetting
and also limited tools for displaying computer code in nice ways.
Wiki formats are therefore less suitable for scientific reports compared
to the other formats mentioned here.</p>
</div>
<div class="section" id="doconce">
<h4>DocOnce<a class="headerlink" href="#doconce" title="Permalink to this headline">¶</a></h4>
<p>Since it is difficult to choose the right tool or format for writing
a scientific report, it is advantageous to write the content in a
format that easily translates to LaTeX, HTML, Sphinx, Markdown,
and various wikis. <a class="reference external" href="https://github.com/hplgit/doconce">DocOnce</a> is such
a tool. It is similar to Pandoc, but offers some special convenient
features for writing about mathematics and programming.
The <a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports//_static/report.do.txt.html">tagging is modest</a>,
somewhere between LaTeX and Markdown.
The program <tt class="docutils literal"><span class="pre">decay_exper_do.py</span></tt> demonstrates how to generate (and write)
DocOnce code for a report.</p>
</div>
<div class="section" id="worked-example">
<h4>Worked example<a class="headerlink" href="#worked-example" title="Permalink to this headline">¶</a></h4>
<p>The HTML, LaTeX (PDF), Sphinx, and DocOnce formats for the scientific
report whose content is outlined above, are exemplified
with source codes and results at the
web pages associated with this teaching material:
<a class="reference external" href="http://tinyurl.com/k3sdbuv/writing_reports/">http://tinyurl.com/k3sdbuv/writing_reports/</a>.</p>
</div>
</div>
<div class="section" id="publishing-a-complete-project">
<span id="decay-exper-github"></span><h3>Publishing a complete project<a class="headerlink" href="#publishing-a-complete-project" title="Permalink to this headline">¶</a></h3>
<p>A report documenting scientific investigations should be accompanied by
all the software and data used for the investigations so that others
have a possibility to redo the work and assess the qualify of the results.
This possibility is important for <em>reproducible research</em> and
hence reaching reliable scientific conclusions.</p>
<p>One way of documenting a complete project is to make a directory tree
with all relevant files. Preferably, the tree is published at
some project hosting site like <a class="reference external" href="http://hplgit.github.com/teamods/bitgit/html/">Bitbucket, GitHub, or Googlecode</a> so that others can download it
as a tarfile, zipfile, or clone the files directly using a version control
system like Mercurial or Git.
For the investigations outlined in the section <a class="reference internal" href="#decay-exper-report"><em>Making a report</em></a>,
we can create a directory tree with files</p>
<div class="highlight-text"><div class="highlight"><pre>setup.py
./src:
   decay_mod.py
./doc:
   ./src:
      decay_exper1_mathjax.py
      make_report.sh
      run.sh
   ./pub:
      report.html
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">src</span></tt> directory holds source code (modules) to be reused in other projects,
the <tt class="docutils literal"><span class="pre">setup.py</span></tt> builds and installs such software,
the <tt class="docutils literal"><span class="pre">doc</span></tt> directory contains the documentation, with <tt class="docutils literal"><span class="pre">src</span></tt> for the
source of the documentation and <tt class="docutils literal"><span class="pre">pub</span></tt> for ready-made, published documentation.
The <tt class="docutils literal"><span class="pre">run.sh</span></tt> file is a simple Bash script listing the <tt class="docutils literal"><span class="pre">python</span></tt> command
we used to run <tt class="docutils literal"><span class="pre">decay_exper1_mathjax.py</span></tt> to generate the experiments and
the <tt class="docutils literal"><span class="pre">report.html</span></tt> file.</p>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<div class="section" id="exercise-1-refactor-a-flat-program-in-terms-of-a-function">
<span id="decay-exer-main2func"></span><h3>Exercise 1: Refactor a flat program in terms of a function<a class="headerlink" href="#exercise-1-refactor-a-flat-program-in-terms-of-a-function" title="Permalink to this headline">¶</a></h3>
<p>For simple ODEs of the form</p>
<div class="math">
\[u' = f(t),\quad u(0)=I,\ t\in (0,T]\]</div>
<p>we can find the solution by straightforward integration:</p>
<div class="math">
\[u(t) = \int_0^t f(\tau) d\tau{\thinspace .}\]</div>
<p>To compute <span class="math">\(u(t)\)</span> for <span class="math">\(t\in [0,T]\)</span>, we introduce a uniform time mesh with
points <span class="math">\(t_n=n\Delta t\)</span> and apply to Trapezoidal rule to approximate the
integral. Suppose we have computed the numerical approximation <span class="math">\(u^n\)</span> to
<span class="math">\(u(t_n)\)</span>. We have</p>
<div class="math">
\[u(t_{n+1}) = u(t_n) + \int_{t_n}^{t_{n+1}} f(\tau)d\tau{\thinspace .}\]</div>
<p>Using the Trapezoidal rule we get</p>
<div class="math">
\[u^{n+1} = u^n + \frac{1}{2}\Delta t (f(t_n) + f(t_{n+1})){\thinspace .}\]</div>
<p>The starting value is <span class="math">\(u^0=I\)</span>.
A corresponding implementation for the case <span class="math">\(f(t)=2t+1\)</span> is given next.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># f(t) is 2*t + 1</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">2</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.2</span>               <span class="c"># time step</span>
<span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>  <span class="c"># no of mesh points</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a flat program. Refactor the program as a function
<tt class="docutils literal"><span class="pre">solver(f,</span> <span class="pre">I,</span> <span class="pre">T,</span> <span class="pre">dt)</span></tt>, where <tt class="docutils literal"><span class="pre">f</span></tt> is the Python implementation of
the mathematical function <span class="math">\(f(t)\)</span> that is to be integrated. The
return value of <tt class="docutils literal"><span class="pre">solver</span></tt> is the pair (<tt class="docutils literal"><span class="pre">u</span></tt>, <tt class="docutils literal"><span class="pre">t</span></tt>) representing
the solution values and the associated time mesh.
Filename: <tt class="docutils literal"><span class="pre">integrate.py</span></tt>.</p>
<div class="section" id="remarks">
<h4>Remarks<a class="headerlink" href="#remarks" title="Permalink to this headline">¶</a></h4>
<p>Many prefer to do a first implementation of an algorithm as a flat
program and hardcode formulas, here the <span class="math">\(f(t)\)</span>, into the algorithm.
Unfortunately, this coding style makes it difficult to reuse a
well-tested algorithm. When the flat program works, it is strongly
recommended to <em>refactor</em> the code (i.e., rearrange the statements)
such that general algorithms are encapsulated in Python functions.
The function arguments should be chosen such that the function
can be applied for a large class of
problems, here all problems that can be expressed as <span class="math">\(u'=f(t)\)</span>,.</p>
</div>
</div>
<div class="section" id="exercise-2-compare-methods-for-a-given-time-mesh">
<span id="decay-exer-plot-dtconst"></span><h3>Exercise 2: Compare methods for a given time mesh<a class="headerlink" href="#exercise-2-compare-methods-for-a-given-time-mesh" title="Permalink to this headline">¶</a></h3>
<p>Make a program that imports the <tt class="docutils literal"><span class="pre">solver</span></tt> function from the
<tt class="docutils literal"><span class="pre">decay_mod</span></tt> module and offers a function <tt class="docutils literal"><span class="pre">compare(dt,</span> <span class="pre">I,</span> <span class="pre">a)</span></tt> for
comparing, in a plot, the methods corresponding to <span class="math">\(\theta=0,0.5,1\)</span>
and the exact solution.  This plot shows the accuracy of the methods
for a given time mesh. Read input data for the problem from the
command line using appropriate functions in the <tt class="docutils literal"><span class="pre">decay_mod</span></tt> module
(the <tt class="docutils literal"><span class="pre">--dt</span></tt> option for giving several time step values can be reused:
just use the first time step value for the computations).
Filename: <tt class="docutils literal"><span class="pre">decay_compare_theta.py</span></tt>.</p>
</div>
<div class="section" id="problem-3-write-a-doctest">
<span id="decay-exer-doctest1"></span><h3>Problem 3: Write a doctest<a class="headerlink" href="#problem-3-write-a-doctest" title="Permalink to this headline">¶</a></h3>
<p>Type in the following program and equip the <tt class="docutils literal"><span class="pre">roots</span></tt> function with a doctest:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="c"># This sqrt(x) returns real if x&gt;0 and complex if x&lt;0</span>
<span class="kn">from</span> <span class="nn">numpy.lib.scimath</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="k">def</span> <span class="nf">roots</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the roots of the quadratic polynomial</span>
<span class="sd">    p(x) = a*x**2 + b*x + c.</span>

<span class="sd">    The roots are real or complex objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
<span class="k">print</span> <span class="n">roots</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>Make sure to test both real and complex roots.
Write out numbers with 14 digits or less.
Filename: <tt class="docutils literal"><span class="pre">doctest_roots.py</span></tt>.</p>
</div>
<div class="section" id="problem-4-write-a-nose-test">
<span id="decay-exer-nosetest1"></span><h3>Problem 4: Write a nose test<a class="headerlink" href="#problem-4-write-a-nose-test" title="Permalink to this headline">¶</a></h3>
<p>Make a nose test for the <tt class="docutils literal"><span class="pre">roots</span></tt> function in <a class="reference internal" href="#decay-exer-doctest1"><em>Problem 3: Write a doctest</em></a>.
Filename: <tt class="docutils literal"><span class="pre">test_roots.py</span></tt>.</p>
</div>
<div class="section" id="problem-5-make-a-module">
<span id="decay-exer-module1"></span><h3>Problem 5: Make a module<a class="headerlink" href="#problem-5-make-a-module" title="Permalink to this headline">¶</a></h3>
<p>Let</p>
<div class="math">
\[q(t) = \frac{RAe^{at}}{R + A(e^{at} - 1)}
{\thinspace .}\]</div>
<p>Make a Python module <tt class="docutils literal"><span class="pre">q_module</span></tt> containing two functions <tt class="docutils literal"><span class="pre">q(t)</span></tt> and
<tt class="docutils literal"><span class="pre">dqdt(t)</span></tt> for computing <span class="math">\(q(t)\)</span> and <span class="math">\(q'(t)\)</span>, respectively. Perform a
<tt class="docutils literal"><span class="pre">from</span> <span class="pre">numpy</span> <span class="pre">import</span> <span class="pre">*</span></tt> in this module. Import <tt class="docutils literal"><span class="pre">q</span></tt> and <tt class="docutils literal"><span class="pre">dqdt</span></tt> in another
file using the &#8220;star import&#8221; construction <tt class="docutils literal"><span class="pre">from</span> <span class="pre">q_module</span> <span class="pre">import</span>
<span class="pre">*</span></tt>. All objects available in this file is given by <tt class="docutils literal"><span class="pre">dir()</span></tt>. Print
<tt class="docutils literal"><span class="pre">dir()</span></tt> and <tt class="docutils literal"><span class="pre">len(dir())</span></tt>.  Then change the import of <tt class="docutils literal"><span class="pre">numpy</span></tt> in
<tt class="docutils literal"><span class="pre">q_module.py</span></tt> to <tt class="docutils literal"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></tt>. What is the effect of this
import on the number of objects in <tt class="docutils literal"><span class="pre">dir()</span></tt> in a file that does <tt class="docutils literal"><span class="pre">from</span>
<span class="pre">q_module</span> <span class="pre">import</span> <span class="pre">*</span></tt>?
Filename: <tt class="docutils literal"><span class="pre">q_module.py</span></tt>.</p>
</div>
<div class="section" id="exercise-6-make-use-of-a-class-implementation">
<span id="decay-exer-decay-class-exper"></span><h3>Exercise 6: Make use of a class implementation<a class="headerlink" href="#exercise-6-make-use-of-a-class-implementation" title="Permalink to this headline">¶</a></h3>
<p>We want to solve the exponential decay problem <span class="math">\(u'=-au\)</span>, <span class="math">\(u(0)=I\)</span>,
for several <span class="math">\(\Delta t\)</span> values and <span class="math">\(\theta=0,0.5,1\)</span>.
For each <span class="math">\(\Delta t\)</span> value, we want to make a plot where the
three solutions corresponding to <span class="math">\(\theta=0,0.5,1\)</span> appear along with
the exact solution.
Write a function <tt class="docutils literal"><span class="pre">experiment</span></tt> to accomplish this. The function should
import the classes <tt class="docutils literal"><span class="pre">Problem</span></tt>, <tt class="docutils literal"><span class="pre">Solver</span></tt>, and <tt class="docutils literal"><span class="pre">Visualizer</span></tt> from the
<a class="reference external" href="http://tinyurl.com/jvzzcfn/decay/decay_class.py">decay_class</a>
module and make use of these. A new command-line option <tt class="docutils literal"><span class="pre">--dt_values</span></tt>
must be added to allow the user to specify the <span class="math">\(\Delta t\)</span> values on
the command line (the options <tt class="docutils literal"><span class="pre">--dt</span></tt> and <tt class="docutils literal"><span class="pre">--theta</span></tt> implemented
by the <tt class="docutils literal"><span class="pre">decay_class</span></tt> module have then no effect
when running the <tt class="docutils literal"><span class="pre">experiment</span></tt> function).
Note that the classes in the <tt class="docutils literal"><span class="pre">decay_class</span></tt> module should <em>not</em> be
modified.
Filename: <tt class="docutils literal"><span class="pre">decay_class_exper.py</span></tt>.</p>
</div>
<div class="section" id="exercise-7-generalize-a-class-implementation">
<span id="decay-exer-decay-class2"></span><h3>Exercise 7: Generalize a class implementation<a class="headerlink" href="#exercise-7-generalize-a-class-implementation" title="Permalink to this headline">¶</a></h3>
<p>Consider the file <a class="reference external" href="http://tinyurl.com/jvzzcfn/decay/decay_class.py">decay_class.py</a>
where the exponential decay problem <span class="math">\(u'=-au\)</span>, <span class="math">\(u(0)=I\)</span>, is implemented
via the classes <tt class="docutils literal"><span class="pre">Problem</span></tt>, <tt class="docutils literal"><span class="pre">Solver</span></tt>, and <tt class="docutils literal"><span class="pre">Visualizer</span></tt>.
Extend the classes to handle the more general problem</p>
<div class="math">
\[u'(t) = -a(t)u(t) + b(t),\quad u(0)=I,\ t\in (0,T],\]</div>
<p>using the <span class="math">\(\theta\)</span>-rule for discretization.</p>
<p>In the case with arbitrary functions <span class="math">\(a(t)\)</span> and <span class="math">\(b(t)\)</span> the problem class
is no longer guaranteed to provide an exact solution. Let
the <tt class="docutils literal"><span class="pre">u_exact</span></tt> in class <tt class="docutils literal"><span class="pre">Problem</span></tt> return <tt class="docutils literal"><span class="pre">None</span></tt> if the exact
solution for the particular problem is not available. Modify classes
<tt class="docutils literal"><span class="pre">Solver</span></tt> and <tt class="docutils literal"><span class="pre">Visualizer</span></tt> accordingly.</p>
<p>Add test functions <tt class="docutils literal"><span class="pre">test_*()</span></tt> for the nose testing tool in the module.
Also add a demo example where the environment suddenly changes
(modeled as an abrupt change in the decay rate <span class="math">\(a\)</span>):</p>
<div class="math">
\[\begin{split}a(t) =\left\lbrace\begin{array}{ll}
1, &amp; 0\leq t\leq t_p,\\
k, &amp; t&gt; t_p,\end{array}\right.\end{split}\]</div>
<p>where <span class="math">\(t_p\)</span> is the point of time the environment changes. Take <span class="math">\(t_p=1\)</span>
and make plots that illustrate the effect of having <span class="math">\(k\gg 1\)</span> and <span class="math">\(k\ll 1\)</span>.
Filename: <tt class="docutils literal"><span class="pre">decay_class2.py</span></tt>.</p>
</div>
<div class="section" id="exercise-8-generalize-an-advanced-class-implementation">
<span id="decay-exer-decay-class3"></span><h3>Exercise 8: Generalize an advanced class implementation<a class="headerlink" href="#exercise-8-generalize-an-advanced-class-implementation" title="Permalink to this headline">¶</a></h3>
<p>Solve <a class="reference internal" href="#decay-exer-decay-class2"><em>Exercise 7: Generalize a class implementation</em></a> by utilizing the
class implementations in
<a class="reference external" href="http://tinyurl.com/jvzzcfn/decay/decay_class_oo.py">decay_class_oo.py</a>.
Filename: <tt class="docutils literal"><span class="pre">decay_class3.py</span></tt>.</p>
</div>
</div>
<div class="section" id="bibliography">
<h2>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline">¶</a></h2>
<table class="docutils citation" frame="void" id="ref1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[Ref1]</a></td><td><strong>H. P. Langtangen</strong>. <em>A Primer on Scientific Programming With Python</em>,
Springer,
2012.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <center>
            <p class="logo"><a href="http://cbc.simula.no/" title="Go to Center for Biomedical Computing">
              <img class="logo" src="_static/cbc_logo.png" alt="Logo"/>
            </a></p>
            </center>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Scientific software engineering for a simple ODE model</a><ul>
<li><a class="reference internal" href="#sample-problem-and-code">Sample problem and code</a><ul>
<li><a class="reference internal" href="#mathematical-problem">Mathematical problem</a></li>
<li><a class="reference internal" href="#implementation-1">Implementation  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-interfaces">User interfaces</a><ul>
<li><a class="reference internal" href="#creating-command-line-interfaces">Creating command-line interfaces</a><ul>
<li><a class="reference internal" href="#reading-a-sequence-of-command-line-arguments">Reading a sequence of command-line arguments</a></li>
<li><a class="reference internal" href="#working-with-an-argument-parser">Working with an argument parser</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-a-graphical-web-user-interface">Creating a graphical web user interface</a><ul>
<li><a class="reference internal" href="#making-a-compute-function">Making a compute function</a></li>
<li><a class="reference internal" href="#generating-the-user-interface">Generating the user interface</a></li>
<li><a class="reference internal" href="#running-the-web-application">Running the web application</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#verification">Verification</a><ul>
<li><a class="reference internal" href="#comparison-with-hand-calculations">Comparison with hand calculations</a></li>
<li><a class="reference internal" href="#test-function">Test function</a></li>
<li><a class="reference internal" href="#comparison-with-an-exact-discrete-solution">Comparison with an exact discrete solution</a></li>
<li><a class="reference internal" href="#computing-convergence-rates">Computing convergence rates</a><ul>
<li><a class="reference internal" href="#estimating">Estimating <span class="math">\(r\)</span></a></li>
<li><a class="reference internal" href="#implementation-2">Implementation  (2)</a></li>
<li><a class="reference internal" href="#debugging-via-convergence-rates">Debugging via convergence rates</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#software-engineering">Software engineering</a><ul>
<li><a class="reference internal" href="#making-a-module">Making a module</a></li>
<li><a class="reference internal" href="#prefixing-imported-functions-by-the-module-name">Prefixing imported functions by the module name</a></li>
<li><a class="reference internal" href="#doctests">Doctests</a></li>
<li><a class="reference internal" href="#unit-testing-with-nose">Unit testing with nose</a><ul>
<li><a class="reference internal" href="#basic-use-of-nose">Basic use of nose</a></li>
<li><a class="reference internal" href="#alternative-assert-statements">Alternative assert statements</a></li>
<li><a class="reference internal" href="#applying-nose">Applying nose</a></li>
<li><a class="reference internal" href="#installation-of-nose">Installation of nose</a></li>
<li><a class="reference internal" href="#using-nose-to-test-modules-with-doctests">Using nose to test modules with doctests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#classical-class-based-unit-testing">Classical class-based unit testing</a><ul>
<li><a class="reference internal" href="#basic-use-of-unittest">Basic use of unittest</a></li>
<li><a class="reference internal" href="#demonstration-of-unittest">Demonstration of unittest</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-simple-problem-and-solver-classes">Implementing simple problem and solver classes</a><ul>
<li><a class="reference internal" href="#the-problem-class-1">The problem class  (1)</a></li>
<li><a class="reference internal" href="#the-solver-class-1">The solver class  (1)</a></li>
<li><a class="reference internal" href="#the-visualizer-class-1">The visualizer class  (1)</a></li>
<li><a class="reference internal" href="#combining-the-objects">Combining the objects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#improving-the-problem-and-solver-classes">Improving the problem and solver classes</a><ul>
<li><a class="reference internal" href="#a-generic-class-for-parameters">A generic class for parameters</a></li>
<li><a class="reference internal" href="#the-problem-class-2">The problem class  (2)</a></li>
<li><a class="reference internal" href="#the-solver-class-2">The solver class  (2)</a></li>
<li><a class="reference internal" href="#the-visualizer-class-2">The visualizer class  (2)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#performing-scientific-experiments">Performing scientific experiments</a><ul>
<li><a class="reference internal" href="#software">Software</a></li>
<li><a class="reference internal" href="#combining-plot-files">Combining plot files</a></li>
<li><a class="reference internal" href="#interpreting-output-from-other-programs">Interpreting output from other programs</a></li>
<li><a class="reference internal" href="#making-a-report">Making a report</a><ul>
<li><a class="reference internal" href="#plain-html">Plain HTML</a></li>
<li><a class="reference internal" href="#html-with-mathjax">HTML with MathJax</a></li>
<li><a class="reference internal" href="#latex">LaTeX</a></li>
<li><a class="reference internal" href="#sphinx">Sphinx</a></li>
<li><a class="reference internal" href="#markdown">Markdown</a></li>
<li><a class="reference internal" href="#wiki-formats">Wiki formats</a></li>
<li><a class="reference internal" href="#doconce">DocOnce</a></li>
<li><a class="reference internal" href="#worked-example">Worked example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#publishing-a-complete-project">Publishing a complete project</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises">Exercises</a><ul>
<li><a class="reference internal" href="#exercise-1-refactor-a-flat-program-in-terms-of-a-function">Exercise 1: Refactor a flat program in terms of a function</a><ul>
<li><a class="reference internal" href="#remarks">Remarks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-2-compare-methods-for-a-given-time-mesh">Exercise 2: Compare methods for a given time mesh</a></li>
<li><a class="reference internal" href="#problem-3-write-a-doctest">Problem 3: Write a doctest</a></li>
<li><a class="reference internal" href="#problem-4-write-a-nose-test">Problem 4: Write a nose test</a></li>
<li><a class="reference internal" href="#problem-5-make-a-module">Problem 5: Make a module</a></li>
<li><a class="reference internal" href="#exercise-6-make-use-of-a-class-implementation">Exercise 6: Make use of a class implementation</a></li>
<li><a class="reference internal" href="#exercise-7-generalize-a-class-implementation">Exercise 7: Generalize a class implementation</a></li>
<li><a class="reference internal" href="#exercise-8-generalize-an-advanced-class-implementation">Exercise 8: Generalize an advanced class implementation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bibliography">Bibliography</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Scientific software engineering for a simple ODE model</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/main_softeng1.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="index.html" title="Scientific software engineering for a simple ODE model"
             >previous</a> |</li>
        <li><a href="index.html">Scientific software engineering for a simple ODE model</a> &raquo;</li> 
      </ul>
    </div>
<div class="wrapper">
  <div class="footer">
  <a href="http://cbc.simula.no"><img src="_static/cbc_banner.png" width="100%"><a>
  </div>
</div>

  </body>
</html>